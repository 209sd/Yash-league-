<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>üåô Ramadan YASH League 2026</title>
<link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;500;600;700&family=Exo+2:ital,wght@0,400;0,600;0,700;0,900;1,700&display=swap" rel="stylesheet"/>
<style>
:root{
  --navy: #040d1a;
  --navy2: #071428;
  --navy3: #0c1e3c;
  --navy4: #112244;
  --gold: #f0c040;
  --gold2: #d4a820;
  --neon: #39ff8a;
  --neon2: #00dd66;
  --white: #f0f4ff;
  --gray: #6a7fa0;
  --gray2: #a0b0cc;
  --red: #ff4466;
  --blue: #4488ff;
  --orange: #ff9933;
  --glass: rgba(12,30,60,0.78);
}
body.light-theme{
  --navy: #f0f4ff;
  --navy2: #e4eaf8;
  --navy3: #d8e0f0;
  --navy4: #c8d4e8;
  --white: #0a1628;
  --gray: #4a5a80;
  --gray2: #2a3a60;
  --glass: rgba(220,230,248,0.88);
  background:var(--navy);
}
body.light-theme #stars{opacity:.15;}
body.light-theme #sidebar{background:rgba(220,230,255,.97);}
body.light-theme #topbar{background:rgba(220,230,255,.9);}
body.light-theme .card{background:var(--glass);}
*{box-sizing:border-box;margin:0;padding:0;}
html,body{height:100%;background:var(--navy);color:var(--white);font-family:'Rajdhani',sans-serif;overflow:hidden;}
#content{flex:1;overflow-y:auto;overflow-x:hidden;padding:28px;min-height:0;}
::-webkit-scrollbar{width:5px;height:5px;}
::-webkit-scrollbar-track{background:rgba(255,255,255,0.03);}
::-webkit-scrollbar-thumb{background:rgba(240,192,64,0.35);border-radius:3px;}

/* ===== STAR FIELD ===== */
#stars{position:fixed;inset:0;pointer-events:none;z-index:0;overflow:hidden;}
.star{position:absolute;border-radius:50%;background:var(--gold);animation:twinkle var(--d) var(--delay) infinite ease-in-out alternate;}
@keyframes twinkle{0%{opacity:.08;transform:scale(.7);}100%{opacity:.7;transform:scale(1.3);}}

/* ===== LAYOUT ===== */
#app{display:flex;height:100vh;position:relative;z-index:1;}
#sidebar{width:240px;flex-shrink:0;background:rgba(7,20,40,.97);border-right:1px solid var(--navy4);display:flex;flex-direction:column;transition:width .3s;overflow:hidden;z-index:50;}
#sidebar.collapsed{width:0;}
#main{flex:1;display:flex;flex-direction:column;min-width:0;}
#topbar{height:60px;display:flex;align-items:center;padding:0 24px;gap:14px;background:rgba(7,20,40,.9);border-bottom:1px solid var(--navy4);backdrop-filter:blur(20px);flex-shrink:0;}


/* ===== SIDEBAR INNER ===== */
.sb-logo{padding:22px 16px 18px;text-align:center;border-bottom:1px solid var(--navy4);margin-bottom:12px;}
.sb-moon{font-size:34px;display:block;margin-bottom:4px;}
.sb-title{color:var(--gold);font-weight:700;font-size:15px;letter-spacing:1.5px;font-family:'Exo 2',sans-serif;}
.sb-sub{color:var(--neon);font-weight:700;font-size:9px;letter-spacing:3px;margin-top:2px;}
.sb-nav{flex:1;display:flex;flex-direction:column;gap:2px;padding:0 10px;overflow-y:auto;}
.nav-btn{display:flex;align-items:center;gap:11px;width:100%;padding:10px 14px;border-radius:11px;border:none;cursor:pointer;background:transparent;color:var(--gray);border-left:3px solid transparent;transition:all .2s;font-family:'Rajdhani',sans-serif;font-weight:600;font-size:13.5px;letter-spacing:.3px;white-space:nowrap;}
.nav-btn.active{background:rgba(240,192,64,.12);color:var(--gold);border-left:3px solid var(--gold);}
.nav-btn:hover:not(.active){background:rgba(255,255,255,.04);color:var(--gray2);}
.nav-btn svg{flex-shrink:0;opacity:.8;}
.nav-btn.active svg{opacity:1;}
.nav-badge{margin-left:auto;background:var(--neon);color:#040d1a;border-radius:20px;padding:1px 7px;font-size:11px;font-weight:800;}
.sb-user{padding:14px 10px 10px;border-top:1px solid var(--navy4);}
.sb-profile{display:flex;align-items:center;gap:10px;padding:8px 10px 10px;}
.sb-avatar{width:36px;height:36px;border-radius:50%;background:linear-gradient(135deg,rgba(240,192,64,.4),rgba(57,255,138,.2));border:2px solid rgba(240,192,64,.4);display:flex;align-items:center;justify-content:center;font-weight:800;font-size:14px;color:var(--gold);flex-shrink:0;}
.sb-uname{color:var(--white);font-size:13px;font-weight:700;}
.sb-urole{color:var(--neon);font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:1px;}

/* ===== GLASS CARD ===== */
.card{background:var(--glass);border:1px solid rgba(240,192,64,.13);backdrop-filter:blur(20px);border-radius:16px;padding:22px;}
.card-sm{padding:16px;}

/* ===== BUTTONS ===== */
.btn{display:inline-flex;align-items:center;gap:6px;border-radius:10px;font-family:'Rajdhani',sans-serif;font-weight:700;cursor:pointer;transition:all .2s;letter-spacing:.4px;border:none;}
.btn-lg{padding:13px 26px;font-size:15px;}
.btn-md{padding:9px 18px;font-size:14px;}
.btn-sm{padding:6px 13px;font-size:12.5px;}
.btn-xs{padding:4px 10px;font-size:12px;}
.btn-gold{background:linear-gradient(135deg,var(--gold),var(--gold2));color:#040d1a;}
.btn-neon{background:linear-gradient(135deg,var(--neon),var(--neon2));color:#040d1a;}
.btn-ghost{background:transparent;color:var(--gold);border:1px solid rgba(240,192,64,.3);}
.btn-dark{background:rgba(255,255,255,.05);color:var(--gray2);border:1px solid rgba(255,255,255,.08);}
.btn-red{background:linear-gradient(135deg,#ff4466,#cc2244);color:#fff;}
.btn:hover{filter:brightness(1.12);}
.btn:disabled{opacity:.45;cursor:not-allowed;}

/* ===== INPUTS ===== */
.inp{width:100%;background:rgba(255,255,255,.05);border:1px solid rgba(240,192,64,.2);border-radius:10px;padding:11px 14px;color:var(--white);font-size:14px;font-family:'Rajdhani',sans-serif;transition:border .2s;outline:none;}
.inp:focus{border-color:rgba(240,192,64,.5);}
.inp::placeholder{color:var(--gray);}
.inp-label{color:var(--gray);font-size:11.5px;font-weight:700;text-transform:uppercase;letter-spacing:1px;display:block;margin-bottom:6px;}

/* ===== TABLE ===== */
.tbl{width:100%;border-collapse:collapse;font-family:'Rajdhani',sans-serif;}
.tbl th{padding:10px 10px;color:var(--gray);font-size:11.5px;font-weight:700;text-transform:uppercase;letter-spacing:1px;border-bottom:1px solid var(--navy4);text-align:center;}
.tbl th.left{text-align:left;}
.tbl td{padding:9px 10px;text-align:center;font-size:13.5px;color:var(--gray2);}
.tbl td.left{text-align:left;}
.tbl tr{border-left:3px solid transparent;transition:background .15s;}
.tbl tr:hover{background:rgba(255,255,255,.02);}
.tbl tr.my-team{background:rgba(57,255,138,.05);border-left:3px solid var(--neon);}

/* ===== TEAM BADGE ===== */
.tbadge{border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:800;letter-spacing:.5px;flex-shrink:0;}

/* ===== FIXTURE CARD ===== */
.fcard{background:rgba(255,255,255,.03);border:1px solid rgba(240,192,64,.09);border-radius:12px;padding:14px 18px;display:flex;align-items:center;gap:12px;transition:all .2s;}
.fcard:hover{background:rgba(255,255,255,.05);}
.fscore{background:rgba(240,192,64,.13);border:1px solid rgba(240,192,64,.28);border-radius:10px;padding:7px 14px;text-align:center;min-width:88px;font-family:'Exo 2',sans-serif;font-weight:900;font-size:20px;color:var(--gold);}
.fvs{background:rgba(57,255,138,.08);border:1px solid rgba(57,255,138,.2);border-radius:10px;padding:7px 14px;text-align:center;min-width:88px;}
.fvs .ftime{color:var(--neon);font-weight:700;font-size:13px;}
.fvs .fdate{color:var(--gray);font-size:11px;margin-top:2px;}

/* ===== PITCH ===== */
.pitch{background:linear-gradient(180deg,#0a3020,#0d4028 50%,#0a3020);border-radius:16px;border:2px solid rgba(57,255,138,.18);position:relative;overflow:hidden;}
.ppos{position:absolute;transform:translate(-50%,-50%);width:34px;height:34px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:8.5px;font-weight:800;cursor:pointer;transition:all .2s;flex-direction:column;text-align:center;}
.ppos:hover{transform:translate(-50%,-50%) scale(1.15);}

/* ===== SLIDER ===== */
.tslider{-webkit-appearance:none;width:100%;height:5px;border-radius:3px;outline:none;cursor:pointer;}
.tslider::-webkit-slider-thumb{-webkit-appearance:none;width:14px;height:14px;border-radius:50%;cursor:pointer;}

/* ===== ANNOUNCEMENT ===== */
.ann{border-radius:12px;padding:14px 16px;display:flex;gap:12px;align-items:flex-start;}
.ann-special{background:rgba(240,192,64,.1);border:1px solid rgba(240,192,64,.2);}
.ann-info{background:rgba(68,136,255,.1);border:1px solid rgba(68,136,255,.2);}
.ann-rule{background:rgba(57,255,138,.1);border:1px solid rgba(57,255,138,.2);}

/* ===== CHAT ===== */
.chat-wrap{display:flex;flex-direction:column;height:360px;}
.chat-msgs{flex:1;overflow-y:auto;padding-bottom:10px;}
.chat-bubble{max-width:75%;border-radius:14px;padding:9px 13px;font-size:13px;line-height:1.5;}
.chat-me{background:rgba(240,192,64,.15);border:1px solid rgba(240,192,64,.22);border-radius:14px 14px 4px 14px;margin-left:auto;}
.chat-other{background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.08);border-radius:14px 14px 14px 4px;}
.chat-bar{display:flex;gap:8px;margin-top:10px;}

/* ===== MODAL ===== */
.modal-bg{position:fixed;inset:0;background:rgba(4,13,26,.93);z-index:200;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(8px);}
.modal-box{width:min(560px,95vw);max-height:88vh;overflow-y:auto;}

/* ===== LOGIN ===== */
#login-screen{position:fixed;inset:0;z-index:300;display:flex;align-items:center;justify-content:center;background:radial-gradient(ellipse at 30% 20%,rgba(240,192,64,.08),transparent 50%),radial-gradient(ellipse at 70% 80%,rgba(57,255,138,.06),transparent 50%),var(--navy);}
.login-box{width:min(460px,93vw);position:relative;z-index:10;}
.login-logo{text-align:center;margin-bottom:32px;}
.login-moon{font-size:60px;display:block;animation:moonbob 3s ease-in-out infinite;}
@keyframes moonbob{0%,100%{transform:translateY(0);}50%{transform:translateY(-8px);}}
.login-title{color:var(--gold);font-family:'Exo 2',sans-serif;font-weight:900;font-size:30px;letter-spacing:2px;text-shadow:0 0 30px rgba(240,192,64,.5);}
.login-sub{color:var(--neon);font-weight:700;font-size:13px;letter-spacing:4px;margin-top:3px;}

/* ===== MISC ===== */
.section-title{color:var(--gold);font-family:'Exo 2',sans-serif;font-weight:700;font-size:20px;margin-bottom:22px;display:flex;align-items:center;gap:10px;}
.grid2{display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:20px;}
.grid3{display:grid;grid-template-columns:repeat(auto-fill,minmax(190px,1fr));gap:14px;}
.flex-row{display:flex;align-items:center;gap:10px;}
.flex-wrap{display:flex;flex-wrap:wrap;gap:8px;}
.tag{padding:2px 8px;border-radius:6px;font-size:11px;font-weight:700;}
.tag-gold{background:rgba(240,192,64,.15);color:var(--gold);}
.tag-neon{background:rgba(57,255,138,.15);color:var(--neon);}
.tag-red{background:rgba(255,68,102,.15);color:var(--red);}
.tag-blue{background:rgba(68,136,255,.15);color:var(--blue);}
.pts-cell{color:var(--gold);font-weight:800;font-size:15px;font-family:'Exo 2',sans-serif;text-shadow:0 0 8px rgba(240,192,64,.4);}
.pos-gold{color:var(--gold);}
.pos-silver{color:#c0c8d8;}
.pos-bronze{color:#cd7f32;}
.stat-box{flex:1;min-width:130px;}
.stat-val{font-family:'Exo 2',sans-serif;font-weight:900;font-size:27px;line-height:1;margin-bottom:4px;}
.stat-lbl{color:var(--gray);font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:1px;}
.divider{border:none;border-top:1px solid var(--navy4);margin:14px 0;}
.page{animation:fadeUp .3s ease;}
@keyframes fadeUp{from{opacity:0;transform:translateY(12px);}to{opacity:1;transform:translateY(0);}}
.pill{border-radius:20px;padding:3px 10px;font-size:11px;font-weight:800;}
.scrollable{overflow-x:auto;}
.mr8{margin-right:8px;}
.mb16{margin-bottom:16px;}
.mt16{margin-top:16px;}
.mt8{margin-top:8px;}
.text-gold{color:var(--gold);}
.text-neon{color:var(--neon);}
.text-gray{color:var(--gray);}
.text-white{color:var(--white);}
.fw800{font-weight:800;}
.fs14{font-size:14px;}
.fs13{font-size:13px;}
.fs12{font-size:12px;}
/* topbar pills */
.tb-pill{background:rgba(240,192,64,.1);border:1px solid rgba(240,192,64,.25);border-radius:20px;padding:4px 13px;color:var(--gold);font-size:12px;font-weight:700;}
.tb-pill-neon{background:rgba(57,255,138,.1);border:1px solid rgba(57,255,138,.25);border-radius:20px;padding:4px 13px;color:var(--neon);font-size:12px;font-weight:700;}
/* credential table */
.cred-table{width:100%;border-collapse:collapse;font-size:13px;}
.cred-table td,.cred-table th{padding:8px 12px;border:1px solid var(--navy4);}
.cred-table th{background:rgba(240,192,64,.08);color:var(--gold);font-size:12px;text-transform:uppercase;letter-spacing:.8px;}
.cred-table td{color:var(--gray2);}
.cred-table td.mono{font-family:monospace;color:var(--neon);font-size:12px;}
/* ===== SQUAD & PLAYER CARDS ===== */
.squad-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(210px,1fr));gap:12px;}
.player-card{background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.07);border-radius:14px;padding:16px;cursor:pointer;transition:all .2s;position:relative;}
.player-card:hover{background:rgba(255,255,255,.06);border-color:rgba(240,192,64,.25);transform:translateY(-2px);}
.player-card.in-xi{border-color:rgba(57,255,138,.4);background:rgba(57,255,138,.05);}
.player-card.in-xi::after{content:"XI";position:absolute;top:10px;right:10px;background:var(--neon);color:#040d1a;font-size:9px;font-weight:800;padding:2px 6px;border-radius:5px;}
.pos-chip{display:inline-block;padding:2px 8px;border-radius:6px;font-size:11px;font-weight:800;letter-spacing:.5px;}
.pos-gk{background:rgba(240,192,64,.2);color:var(--gold);}
.pos-df{background:rgba(68,136,255,.2);color:var(--blue);}
.pos-mf{background:rgba(57,255,138,.2);color:var(--neon);}
.pos-fw{background:rgba(255,102,51,.2);color:#ff6633;}
.player-num{width:32px;height:32px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-weight:900;font-size:14px;font-family:'Exo 2',sans-serif;flex-shrink:0;}
/* ===== STARTING XI PITCH ===== */
.xi-pitch{background:linear-gradient(180deg,#082818 0%,#0b3820 30%,#0d4028 50%,#0b3820 70%,#082818 100%);border-radius:18px;border:2px solid rgba(57,255,138,.2);position:relative;overflow:hidden;user-select:none;}
.xi-slot{position:absolute;transform:translate(-50%,-50%);width:52px;height:52px;border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .25s;flex-direction:column;text-align:center;border:2px dashed rgba(255,255,255,.25);background:rgba(255,255,255,.04);}
.xi-slot:hover{border-color:var(--gold);background:rgba(240,192,64,.1);}
.xi-slot.filled{border-style:solid;border-color:transparent;}
.xi-slot.filled:hover{transform:translate(-50%,-50%) scale(1.08);}
.xi-slot-label{font-size:8px;font-weight:800;color:rgba(255,255,255,.4);margin-top:1px;}
/* ===== TEAM CHAT ===== */
.tc-wrap{display:flex;flex-direction:column;height:480px;max-width:680px;}
.tc-msgs{flex:1;overflow-y:auto;padding:4px 2px 10px;display:flex;flex-direction:column;gap:10px;}
.tc-bubble{max-width:72%;padding:10px 14px;font-size:13.5px;line-height:1.55;}
.tc-me{background:linear-gradient(135deg,rgba(240,192,64,.18),rgba(240,192,64,.08));border:1px solid rgba(240,192,64,.28);border-radius:16px 16px 4px 16px;align-self:flex-end;}
.tc-other{background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.09);border-radius:16px 16px 16px 4px;align-self:flex-start;}
.tc-name{font-size:10.5px;font-weight:700;text-transform:uppercase;letter-spacing:.8px;margin-bottom:4px;}
.tc-time{font-size:10px;color:var(--gray);margin-top:4px;text-align:right;}
.tc-bar{display:flex;gap:8px;margin-top:12px;padding-top:12px;border-top:1px solid var(--navy4);}
/* ===== STAT RING ===== */
.stat-ring{display:flex;align-items:center;gap:10px;padding:10px 12px;background:rgba(255,255,255,.03);border-radius:12px;border:1px solid rgba(255,255,255,.06);}
/* ===== FORM GUIDE ===== */
.form-dot{width:22px;height:22px;border-radius:50%;display:inline-flex;align-items:center;justify-content:center;font-size:10px;font-weight:900;}
.form-w{background:rgba(57,255,138,.25);color:var(--neon);border:1px solid rgba(57,255,138,.4);}
.form-d{background:rgba(160,176,204,.15);color:var(--gray2);border:1px solid rgba(160,176,204,.3);}
.form-l{background:rgba(255,68,102,.2);color:var(--red);border:1px solid rgba(255,68,102,.35);}
/* ===== STAR RATING ===== */
.star-rating{display:flex;gap:3px;cursor:pointer;}
.star-rating span{font-size:20px;transition:transform .15s;}
.star-rating span:hover{transform:scale(1.2);}
/* ===== KNOCKOUT BRACKET ===== */
.bracket-wrap{overflow-x:auto;padding-bottom:12px;}
.bracket{display:flex;gap:0;min-width:600px;}
.bracket-round{display:flex;flex-direction:column;flex:1;}
.bracket-round-title{color:var(--gold);font-size:11px;font-weight:800;letter-spacing:2px;text-transform:uppercase;text-align:center;padding:10px 0 14px;border-bottom:1px solid var(--navy4);margin-bottom:14px;}
.bracket-matches{display:flex;flex-direction:column;justify-content:space-around;flex:1;gap:8px;}
.bm{background:rgba(255,255,255,.03);border:1px solid rgba(240,192,64,.12);border-radius:10px;padding:10px 14px;position:relative;}
.bm.winner{border-color:rgba(240,192,64,.4);background:rgba(240,192,64,.06);}
.bm-team{display:flex;align-items:center;gap:8px;padding:5px 0;}
.bm-score{margin-left:auto;font-weight:800;font-size:15px;font-family:'Exo 2',sans-serif;color:var(--gold);}
.bm-team.winning .bm-score{color:var(--neon);}
/* ===== PREDICTION ===== */
.pred-btn{flex:1;padding:10px;border-radius:10px;border:2px solid rgba(255,255,255,.1);background:rgba(255,255,255,.03);cursor:pointer;transition:all .2s;text-align:center;font-family:'Rajdhani',sans-serif;font-weight:700;font-size:13px;color:var(--gray2);}
.pred-btn:hover,.pred-btn.selected{border-color:var(--gold);background:rgba(240,192,64,.12);color:var(--gold);}
.pred-btn.selected-draw{border-color:var(--gray2);background:rgba(160,176,204,.1);color:var(--white);}
.pred-bar{height:6px;border-radius:3px;transition:width .5s ease;}
/* ===== COMMENT ===== */
.comment-bubble{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:12px 14px;margin-bottom:8px;}
/* ===== LOGO UPLOAD ===== */
.logo-preview{width:64px;height:64px;border-radius:50%;object-fit:cover;border:2px solid rgba(240,192,64,.4);}
/* ===== SUSPENSION TAG ===== */
.suspended-tag{background:rgba(255,68,102,.2);border:1px solid rgba(255,68,102,.4);color:var(--red);font-size:9px;font-weight:800;padding:2px 6px;border-radius:5px;letter-spacing:.5px;}
.warning-tag{background:rgba(240,192,64,.15);border:1px solid rgba(240,192,64,.3);color:var(--gold);font-size:9px;font-weight:800;padding:2px 6px;border-radius:5px;letter-spacing:.5px;}
/* ===== MOTM ===== */
.motm-card{background:linear-gradient(135deg,rgba(240,192,64,.15),rgba(57,255,138,.06));border:1px solid rgba(240,192,64,.3);border-radius:14px;padding:16px;text-align:center;}
/* ===== COUNTDOWN ===== */
.countdown-unit{text-align:center;min-width:44px;}
.countdown-val{font-family:'Exo 2',sans-serif;font-weight:900;font-size:22px;color:var(--gold);line-height:1;}
.countdown-lbl{color:var(--gray);font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:1px;margin-top:2px;}
/* ===== SETTINGS SECTION ===== */
.settings-section{background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.07);border-radius:14px;padding:18px;margin-bottom:16px;}
.settings-title{color:var(--gold);font-weight:700;font-size:14px;margin-bottom:14px;display:flex;align-items:center;gap:8px;}
.tab-bar{display:flex;gap:4px;background:rgba(255,255,255,.04);border-radius:12px;padding:4px;margin-bottom:20px;flex-wrap:wrap;}
.tab-btn{flex:1;min-width:80px;padding:8px 14px;border-radius:9px;border:none;cursor:pointer;font-family:'Rajdhani',sans-serif;font-weight:700;font-size:13px;background:transparent;color:var(--gray);transition:all .2s;}
.tab-btn.active{background:linear-gradient(135deg,rgba(240,192,64,.2),rgba(240,192,64,.1));color:var(--gold);}
  #sidebar{width:0;}
  #sidebar.mob-open{width:240px;position:fixed;height:100vh;z-index:100;}
  #content{padding:16px;}
  .grid2,.grid3{grid-template-columns:1fr;}
  .fcard{flex-direction:column;text-align:center;}
  .fcard .fteam-name{display:none;}
}
</style>
</head>
<body>
<!-- ===== STARS ===== -->
<div id="stars"></div>

<!-- ===== LOGIN ===== -->
<div id="login-screen">
  <div class="login-box">
    <div class="login-logo">
      <span class="login-moon">üåô</span>
      <div class="login-title">RAMADAN YASH</div>
      <div class="login-sub">LEAGUE 2026</div>
    </div>
    <div class="card">
      <div style="font-weight:800;font-size:20px;color:var(--white);margin-bottom:22px;font-family:'Exo 2',sans-serif;">Sign In to Your Account</div>
      <div style="margin-bottom:14px;">
        <label class="inp-label">Username</label>
        <input id="login-user" class="inp" placeholder="e.g. alnoor_mgr" autocomplete="username"/>
      </div>
      <div style="margin-bottom:6px;">
        <label class="inp-label">Password</label>
        <input id="login-pass" class="inp" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password"/>
      </div>
      <div id="login-err" style="color:var(--red);font-size:13px;min-height:20px;margin-bottom:8px;"></div>
      <button class="btn btn-gold btn-lg" style="width:100%;justify-content:center;" onclick="doLogin()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M11 7L9.6 8.4l2.6 2.6H2v2h10.2l-2.6 2.6L11 17l5-5-5-5zm9 12h-8v2h8c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2h-8v2h8v14z"/></svg>
        Sign In
      </button>
      <div style="text-align:center;margin-top:14px;color:var(--gray);font-size:12px;">‚Äî or ‚Äî</div>
      <button class="btn btn-ghost btn-lg" style="width:100%;justify-content:center;margin-top:10px;" onclick="doGuestLogin()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/></svg>
        Continue as Guest
      </button>


    </div>
  </div>
</div>

<!-- ===== MAIN APP ===== -->
<div id="app" style="display:none;">
  <!-- SIDEBAR -->
  <div id="sidebar">
    <div class="sb-logo" style="position:relative;">
      <button onclick="toggleSidebar()" title="Close sidebar" style="position:absolute;top:10px;right:10px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.1);border-radius:8px;color:var(--gray);cursor:pointer;width:28px;height:28px;display:flex;align-items:center;justify-content:center;transition:all .2s;" onmouseover="this.style.background='rgba(255,68,102,.15)';this.style.color='var(--red)';" onmouseout="this.style.background='rgba(255,255,255,.06)';this.style.color='var(--gray)';">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
      </button>
      <span class="sb-moon">üåô</span>
      <div class="sb-title" id="sb-league-name">RAMADAN YASH</div>
      <div class="sb-sub" id="sb-league-sub">LEAGUE 2026</div>
    </div>
    <div class="sb-nav" id="sb-nav"></div>
    <div class="sb-user">
      <div class="sb-profile">
        <div class="sb-avatar" id="sb-avatar">A</div>
        <div>
          <div class="sb-uname" id="sb-uname">Admin</div>
          <div class="sb-urole" id="sb-urole">League Admin</div>
        </div>
      </div>
      <button class="nav-btn" onclick="doLogout()" style="width:100%;color:var(--red);">
        <svg width="17" height="17" viewBox="0 0 24 24" fill="currentColor"><path d="M17 7l-1.41 1.41L18.17 11H8v2h10.17l-2.58 2.58L17 17l5-5-5-5zm-13 9V8h8V6H4C2.9 6 2 6.9 2 8v8c0 1.1.9 2 2 2h8v-2H4z"/></svg>
        Sign Out
      </button>
    </div>
  </div>

  <!-- MAIN AREA -->
  <div id="main">
    <div id="topbar">
      <button onclick="toggleSidebar()" style="background:none;border:none;color:var(--gray);cursor:pointer;padding:4px;">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg>
      </button>
      <div id="tb-title" style="color:var(--gold);font-weight:800;font-size:16px;letter-spacing:1px;font-family:'Exo 2',sans-serif;">DASHBOARD</div>
      <div style="margin-left:auto;display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
        <div id="tb-badge" class="tb-pill-neon" style="display:none;"></div>
        <div id="sync-badge" style="display:none;padding:4px 12px;border-radius:20px;font-size:11px;font-weight:700;color:#040d1a;transition:all .3s;"></div>
        <div class="tb-pill" id="tb-league-pill">üåô Matchday Season 2026</div>
      </div>
    </div>
    <div id="content"></div>
  </div>
</div>

<!-- MODALS -->
<div id="modal-container"></div>

<script>
// ================================================================
// CREDENTIALS & AUTH
// ================================================================
const TEAMS_DATA = [
  {id:1, name:"Al Noor FC",        short:"NFC",  color:"#f0c040", username:"alnoor",    mgr_pass:"noor2026",   mem_pass:"noorfc",    played:6,won:5,drawn:1,lost:0,gf:18,ga:5},
  {id:2, name:"Crescent United",   short:"CUN",  color:"#39ff8a", username:"crescent",  mgr_pass:"cres2026",   mem_pass:"crescentfc",played:6,won:4,drawn:1,lost:1,gf:14,ga:8},
  {id:3, name:"Desert Eagles",     short:"DEG",  color:"#4488ff", username:"desert",    mgr_pass:"deser2026",  mem_pass:"desertfc",  played:6,won:3,drawn:2,lost:1,gf:12,ga:9},
  {id:4, name:"Hilal Stars",       short:"HST",  color:"#ff6633", username:"hilal",     mgr_pass:"hil2026",    mem_pass:"hilalfc",   played:6,won:3,drawn:0,lost:3,gf:10,ga:11},
  {id:5, name:"Ramadan Warriors",  short:"RWR",  color:"#cc44ff", username:"warriors",  mgr_pass:"war2026",    mem_pass:"warriorsfc",played:6,won:2,drawn:1,lost:3,gf:9, ga:13},
  {id:6, name:"Fajr Phoenix",      short:"FPX",  color:"#ff3366", username:"fajr",      mgr_pass:"fajr2026",   mem_pass:"fajrfc",    played:6,won:1,drawn:1,lost:4,gf:7, ga:16},
  {id:7, name:"Dusk Rovers",       short:"DRV",  color:"#00ccff", username:"dusk",      mgr_pass:"dusk2026",   mem_pass:"duskfc",    played:6,won:1,drawn:0,lost:5,gf:5, ga:18},
  {id:8, name:"Suhoor FC",         short:"SFC",  color:"#ffaa00", username:"suhoor",    mgr_pass:"suhr2026",   mem_pass:"suhoorfc",  played:6,won:0,drawn:2,lost:4,gf:4, ga:20},
];

const ADMIN_CREDENTIALS = {username:"admin", password:"yash2026"};

let currentUser = null;
let currentPage = "dashboard";

function resolveLogin(user, pass) {
  if (user === ADMIN_CREDENTIALS.username && pass === ADMIN_CREDENTIALS.password)
    return {role:"admin", name:"League Admin", teamId:null};
  for (const t of TEAMS_DATA) {
    if (user === t.username + "_mgr" && pass === t.mgr_pass)
      return {role:"manager", name:t.name + " Manager", teamId:t.id};
    if (user === t.username && pass === t.mem_pass)
      return {role:"member", name:t.name + " Member", teamId:t.id};
  }
  return null;
}

function doGuestLogin() {
  currentUser = {role:"guest", name:"Guest", teamId:null};
  document.getElementById("login-screen").style.display = "none";
  document.getElementById("app").style.display = "flex";
  initApp();
}

function doLogin() {
  const u = document.getElementById("login-user").value.trim();
  const p = document.getElementById("login-pass").value;
  const result = resolveLogin(u, p);
  if (!result) { document.getElementById("login-err").textContent = "‚ùå Invalid username or password"; return; }
  currentUser = result;
  document.getElementById("login-screen").style.display = "none";
  document.getElementById("app").style.display = "flex";
  initApp();
}
document.getElementById("login-pass").addEventListener("keydown", e => { if (e.key === "Enter") doLogin(); });
document.getElementById("login-user").addEventListener("keydown", e => { if (e.key === "Enter") doLogin(); });

function doLogout() {
  currentUser = null;
  document.getElementById("login-screen").style.display = "flex";
  document.getElementById("app").style.display = "none";
  document.getElementById("login-user").value = "";
  document.getElementById("login-pass").value = "";
  document.getElementById("login-err").textContent = "";
}

// ================================================================
// PERSISTENCE ‚Äî localStorage keys
// ================================================================
const LS = {
  teams:         "yash_teams",
  fixtures:      "yash_fixtures",
  players:       "yash_players",
  announcements: "yash_announcements",
  messages:      "yash_messages",
  tactics:       "yash_tactics",
  extraTeams:    "yash_extra_teams",
  squads:        "yash_squads",
  startingXI:    "yash_starting_xi",
  teamchat:      "yash_teamchat",
  predictions:   "yash_predictions",
  ratings:       "yash_ratings",
  comments:      "yash_comments",
  motm:          "yash_motm",
  knockout:      "yash_knockout",
  leagueSettings:"yash_league_settings",
  teamLogos:     "yash_team_logos",
};

// Default datasets
const DEFAULT_FIXTURES = [
  {id:1,home:1,away:2,date:"2026-03-10",time:"20:00",hs:3,as:1,status:"completed",md:1},
  {id:2,home:3,away:4,date:"2026-03-10",time:"22:00",hs:2,as:2,status:"completed",md:1},
  {id:3,home:5,away:6,date:"2026-03-11",time:"20:00",hs:2,as:1,status:"completed",md:1},
  {id:4,home:7,away:8,date:"2026-03-11",time:"22:00",hs:1,as:0,status:"completed",md:1},
  {id:5,home:1,away:3,date:"2026-03-17",time:"20:00",hs:null,as:null,status:"upcoming",md:2},
  {id:6,home:2,away:4,date:"2026-03-17",time:"22:00",hs:null,as:null,status:"upcoming",md:2},
  {id:7,home:5,away:7,date:"2026-03-18",time:"20:00",hs:null,as:null,status:"upcoming",md:2},
  {id:8,home:6,away:8,date:"2026-03-18",time:"22:00",hs:null,as:null,status:"upcoming",md:2},
];
const DEFAULT_PLAYERS = [
  {id:1,name:"Hassan Al-Rashid",teamId:1,pos:"ST",goals:7,assists:3,yc:1,rc:0,rating:8.4},
  {id:2,name:"Omar Ibrahim",     teamId:2,pos:"CAM",goals:5,assists:6,yc:2,rc:0,rating:8.1},
  {id:3,name:"Yusuf Karimi",     teamId:3,pos:"LW",goals:5,assists:2,yc:0,rc:0,rating:7.9},
  {id:4,name:"Tariq Mansour",    teamId:1,pos:"CM",goals:4,assists:5,yc:1,rc:0,rating:7.8},
  {id:5,name:"Bilal Ahmed",      teamId:4,pos:"ST",goals:4,assists:2,yc:3,rc:0,rating:7.2},
  {id:6,name:"Nasser Al-Faris",  teamId:2,pos:"RW",goals:3,assists:4,yc:0,rc:0,rating:7.6},
  {id:7,name:"Zaid Hossain",     teamId:5,pos:"AM",goals:3,assists:3,yc:1,rc:0,rating:7.1},
  {id:8,name:"Khalid Salim",     teamId:3,pos:"CM",goals:2,assists:6,yc:2,rc:0,rating:7.5},
];
const DEFAULT_ANNOUNCEMENTS = [
  {id:1,title:"Ramadan Mubarak! League Officially Begins üåô",body:"The Ramadan YASH League 2026 is officially underway. All matches will be played after Isha prayer. May the best team win!",date:"2026-03-01",type:"special"},
  {id:2,title:"Matchday 2 Schedule Confirmed",body:"Matchday 2 fixtures are confirmed. All teams please ensure players arrive 30 minutes before kickoff.",date:"2026-03-15",type:"info"},
  {id:3,title:"Fair Play Award Introduced",body:"Starting Matchday 3, a Fair Play Award will go to the team with the fewest cards. This will serve as a tiebreaker.",date:"2026-03-12",type:"rule"},
];
const DEFAULT_MESSAGES = [
  {id:1,from:"Omar (Crescent)",to:"admin",msg:"Can we reschedule our MD3 fixture to Saturday?",time:"2h ago",read:false},
  {id:2,from:"Admin",to:"crescent_mgr",msg:"Approved ‚Äî fixture updated.",time:"1h ago",read:true},
  {id:3,from:"Yusuf (Desert)",to:"admin",msg:"The team logo I uploaded hasn't been approved yet.",time:"30m ago",read:false},
];

// Helper ‚Äî safely read from localStorage
function lsGet(key, fallback) {
  try {
    const raw = localStorage.getItem(key);
    return raw ? JSON.parse(raw) : fallback;
  } catch(e) { return fallback; }
}
// Helper ‚Äî safely write to localStorage
function lsSet(key, value) {
  try { localStorage.setItem(key, JSON.stringify(value)); } catch(e) {}
}

// ================================================================
// STATE ‚Äî loaded from localStorage, falls back to defaults
// ================================================================
let teams         = lsGet(LS.teams,         JSON.parse(JSON.stringify(TEAMS_DATA)));
let fixtures      = lsGet(LS.fixtures,      JSON.parse(JSON.stringify(DEFAULT_FIXTURES)));
let players       = lsGet(LS.players,       JSON.parse(JSON.stringify(DEFAULT_PLAYERS)));
let announcements = lsGet(LS.announcements, JSON.parse(JSON.stringify(DEFAULT_ANNOUNCEMENTS)));
let messages      = lsGet(LS.messages,      JSON.parse(JSON.stringify(DEFAULT_MESSAGES)));
let tacticState   = lsGet(LS.tactics,       {formation:"2-3-1",attack:65,defense:50,press:70,tempo:55});
let fixtureNextId = 20;

// Default squads (expanded player data per team)
const DEFAULT_SQUADS = {
  1:[
    {id:101,name:"Hassan Al-Rashid",number:9, pos:"ST", goals:7,assists:3,yc:1,rc:0,rating:8.4,age:24,nationality:"Saudi"},
    {id:102,name:"Tariq Mansour",   number:8, pos:"CM", goals:4,assists:5,yc:1,rc:0,rating:7.8,age:26,nationality:"UAE"},
    {id:103,name:"Faisal Al-Omar",  number:1, pos:"GK", goals:0,assists:0,yc:0,rc:0,rating:7.2,age:28,nationality:"Saudi"},
    {id:104,name:"Khalid Nasser",   number:4, pos:"CB", goals:1,assists:0,yc:2,rc:0,rating:7.0,age:23,nationality:"Saudi"},
    {id:105,name:"Rami Al-Bakr",    number:11,pos:"LW", goals:3,assists:2,yc:0,rc:0,rating:7.5,age:22,nationality:"Jordan"},
    {id:106,name:"Ahmed Said",      number:3, pos:"LB", goals:0,assists:1,yc:1,rc:0,rating:6.9,age:25,nationality:"Saudi"},
    {id:107,name:"Nabil Qasim",     number:5, pos:"CB", goals:0,assists:0,yc:1,rc:0,rating:7.1,age:27,nationality:"UAE"},
    {id:108,name:"Jaber Al-Hadi",   number:2, pos:"RB", goals:0,assists:2,yc:0,rc:0,rating:7.3,age:24,nationality:"Saudi"},
    {id:109,name:"Yousef Al-Amir",  number:6, pos:"CDM",goals:1,assists:1,yc:2,rc:0,rating:7.0,age:29,nationality:"Bahrain"},
    {id:110,name:"Sultan Fahad",    number:7, pos:"RW", goals:2,assists:3,yc:0,rc:0,rating:7.4,age:21,nationality:"Saudi"},
    {id:111,name:"Mansoor Ali",     number:10,pos:"CAM",goals:3,assists:4,yc:1,rc:0,rating:7.7,age:23,nationality:"Qatar"},
  ],
  2:[
    {id:201,name:"Omar Ibrahim",    number:10,pos:"CAM",goals:5,assists:6,yc:2,rc:0,rating:8.1,age:25,nationality:"Egypt"},
    {id:202,name:"Nasser Al-Faris", number:7, pos:"RW", goals:3,assists:4,yc:0,rc:0,rating:7.6,age:22,nationality:"Jordan"},
    {id:203,name:"Saif Al-Hamed",   number:1, pos:"GK", goals:0,assists:0,yc:0,rc:0,rating:7.4,age:30,nationality:"UAE"},
    {id:204,name:"Hani Mahmoud",    number:4, pos:"CB", goals:0,assists:1,yc:1,rc:0,rating:7.0,age:26,nationality:"Egypt"},
    {id:205,name:"Ramzi Saleh",     number:9, pos:"ST", goals:4,assists:1,yc:1,rc:0,rating:7.3,age:24,nationality:"Morocco"},
    {id:206,name:"Wael Hassan",     number:3, pos:"LB", goals:0,assists:2,yc:1,rc:0,rating:6.8,age:25,nationality:"Tunisia"},
    {id:207,name:"Badr Al-Sayed",   number:5, pos:"CB", goals:1,assists:0,yc:2,rc:0,rating:7.1,age:28,nationality:"UAE"},
    {id:208,name:"Fady Younis",     number:2, pos:"RB", goals:0,assists:1,yc:0,rc:0,rating:7.2,age:23,nationality:"Lebanon"},
    {id:209,name:"Tarek Fawzy",     number:6, pos:"CM", goals:1,assists:3,yc:0,rc:0,rating:7.5,age:27,nationality:"Egypt"},
    {id:210,name:"Adel Karim",      number:8, pos:"CM", goals:2,assists:2,yc:1,rc:0,rating:7.3,age:24,nationality:"Algeria"},
    {id:211,name:"Zaki Mostafa",    number:11,pos:"LW", goals:2,assists:3,yc:0,rc:0,rating:7.4,age:21,nationality:"Morocco"},
  ],
  3:[
    {id:301,name:"Yusuf Karimi",    number:11,pos:"LW", goals:5,assists:2,yc:0,rc:0,rating:7.9,age:22,nationality:"Iran"},
    {id:302,name:"Khalid Salim",    number:8, pos:"CM", goals:2,assists:6,yc:2,rc:0,rating:7.5,age:26,nationality:"Oman"},
    {id:303,name:"Ali Hamza",       number:1, pos:"GK", goals:0,assists:0,yc:0,rc:0,rating:7.3,age:29,nationality:"Iraq"},
    {id:304,name:"Saad Al-Rashidi", number:4, pos:"CB", goals:1,assists:0,yc:1,rc:0,rating:7.0,age:25,nationality:"Kuwait"},
    {id:305,name:"Firas Nabulsi",   number:9, pos:"ST", goals:3,assists:1,yc:2,rc:0,rating:7.2,age:24,nationality:"Palestine"},
    {id:306,name:"Malik Taha",      number:3, pos:"LB", goals:0,assists:1,yc:0,rc:0,rating:6.9,age:22,nationality:"Jordan"},
    {id:307,name:"Wissam Atef",     number:5, pos:"CB", goals:0,assists:0,yc:1,rc:0,rating:7.0,age:28,nationality:"Syria"},
    {id:308,name:"Hassan Qadri",    number:2, pos:"RB", goals:0,assists:2,yc:0,rc:0,rating:7.1,age:23,nationality:"Oman"},
    {id:309,name:"Ayman Al-Khatib", number:6, pos:"CDM",goals:0,assists:1,yc:3,rc:0,rating:6.8,age:30,nationality:"Libya"},
    {id:310,name:"Samer Eid",       number:7, pos:"RW", goals:2,assists:2,yc:0,rc:0,rating:7.3,age:21,nationality:"Palestine"},
    {id:311,name:"Riad Bensalem",   number:10,pos:"CAM",goals:1,assists:4,yc:1,rc:0,rating:7.4,age:25,nationality:"Algeria"},
  ],
};
// Fill remaining teams with generated squads
for(let tid=4;tid<=8;tid++){
  DEFAULT_SQUADS[tid]=[];
  const positions=["GK","CB","CB","LB","RB","CDM","CM","LW","RW","CAM","ST"];
  const names=["Ahmad","Bilal","Tariq","Yusuf","Hassan","Omar","Ali","Khaled","Faisal","Mahmoud","Sami"];
  positions.forEach((p,i)=>{
    DEFAULT_SQUADS[tid].push({id:tid*100+i+1,name:names[i]+" "+(["Al-Nouri","Said","Khan","Al-Amin","Haddad","Saleh","Farouk","Al-Masri","Abboud","Ghazali","Tamimi"][i]),number:i+1,pos:p,goals:Math.floor(Math.random()*4),assists:Math.floor(Math.random()*3),yc:Math.floor(Math.random()*3),rc:0,rating:+(6.5+Math.random()*1.5).toFixed(1),age:20+Math.floor(Math.random()*12),nationality:"Saudi"});
  });
}

// State
let squads     = lsGet(LS.squads,     JSON.parse(JSON.stringify(DEFAULT_SQUADS)));
let startingXI = lsGet(LS.startingXI, {});
let teamchat   = lsGet(LS.teamchat,   {});
let predictions   = lsGet(LS.predictions,   {});
let ratings       = lsGet(LS.ratings,       {});
let comments      = lsGet(LS.comments,      {});
let motm          = lsGet(LS.motm,          {});
let knockout      = lsGet(LS.knockout,      {bracket:[],stage:"group",generated:false});
let teamLogos     = lsGet(LS.teamLogos,     {});
let leagueSettings= lsGet(LS.leagueSettings,{name:"Ramadan YASH League",subname:"LEAGUE 2026",banner:"",theme:"dark",startDate:"",endDate:"",defaultTime:"20:00",venue:"",description:""});

// ================================================================
// JSONBIN SYNC ‚Äî shared database for all devices
// ================================================================
// üëá PASTE YOUR JSONBIN DETAILS HERE AFTER SETUP
const JSONBIN_BIN_ID  = "6997fb60d0ea881f40c8c354";
const JSONBIN_API_KEY = "$2a$10$xaMqpykHD4/T10U3fQSMpejPZoAiK093/96kIf2tZiIb6b8GqdAfW";
// ================================================================

const JSONBIN_URL = `https://api.jsonbin.io/v3/b/${JSONBIN_BIN_ID}`;
let   _syncTimer  = null;   // debounce handle
let   _syncing    = false;  // prevent overlapping saves
let   _lastEtag   = null;   // track remote version
let   _pollTimer  = null;   // background poll handle

// Merge any extra teams added at runtime into TEAMS_DATA so login works
function mergeExtraTeams(extraList) {
  (extraList||[]).forEach(t => {
    if (!TEAMS_DATA.find(x => x.id === t.id)) TEAMS_DATA.push(t);
  });
}

// Bundle ALL mutable state into one object
function bundleState() {
  const originalIds = [1,2,3,4,5,6,7,8];
  return {
    teams, fixtures, players, announcements, messages,
    tacticState, squads, startingXI, teamchat,
    predictions, ratings, comments, motm, knockout,
    teamLogos, leagueSettings,
    extraTeams: TEAMS_DATA.filter(t => !originalIds.includes(t.id)),
    _v: Date.now()
  };
}

// Apply a remote bundle onto local state
function applyBundle(b) {
  if (!b) return;
  if (b.teams)         teams         = b.teams;
  if (b.fixtures)      fixtures      = b.fixtures;
  if (b.players)       players       = b.players;
  if (b.announcements) announcements = b.announcements;
  if (b.messages)      messages      = b.messages;
  if (b.tacticState)   tacticState   = b.tacticState;
  if (b.squads)        squads        = b.squads;
  if (b.startingXI)    startingXI    = b.startingXI;
  if (b.teamchat)      teamchat      = b.teamchat;
  if (b.predictions)   predictions   = b.predictions;
  if (b.ratings)       ratings       = b.ratings;
  if (b.comments)      comments      = b.comments;
  if (b.motm)          motm          = b.motm;
  if (b.knockout)      knockout      = b.knockout;
  if (b.teamLogos)     teamLogos     = b.teamLogos;
  if (b.leagueSettings)leagueSettings= b.leagueSettings;
  mergeExtraTeams(b.extraTeams);
  // Mirror to localStorage as fast cache
  lsSet("yash_bundle", b);
}

// Check if JSONBin is configured
function jsonbinReady() {
  return JSONBIN_BIN_ID && JSONBIN_API_KEY &&
         JSONBIN_BIN_ID !== "" && JSONBIN_API_KEY !== "";
}

// Push state to JSONBin (debounced 800ms)
async function pushToCloud() {
  if (!jsonbinReady()) return;
  if (_syncing) { schedulePush(); return; }   // retry after current push
  _syncing = true;
  showSyncBadge("saving");
  try {
    const res = await fetch(JSONBIN_URL, {
      method: "PUT",
      headers: {
        "Content-Type": "application/json",
        "X-Master-Key": JSONBIN_API_KEY,
        "X-Bin-Versioning": "false"
      },
      body: JSON.stringify(bundleState())
    });
    if (res.ok) {
      showSyncBadge("saved");
    } else {
      showSyncBadge("error");
      console.warn("JSONBin push failed:", res.status);
    }
  } catch(e) {
    showSyncBadge("error");
    console.warn("JSONBin push error:", e);
  }
  _syncing = false;
}

// Pull latest state from JSONBin
async function pullFromCloud(silent=false) {
  if (!jsonbinReady()) return false;
  try {
    const res = await fetch(JSONBIN_URL + "/latest", {
      headers: { "X-Master-Key": JSONBIN_API_KEY }
    });
    if (!res.ok) return false;
    const etag = res.headers.get("X-JSON-ETag") || res.headers.get("ETag");
    const data = await res.json();
    const bundle = data.record || data;
    // Only apply + re-render if data actually changed
    if (etag && etag === _lastEtag) return false;
    _lastEtag = etag;
    applyBundle(bundle);
    if (!silent) {
      applyLeagueSettings();
      if (currentUser) { buildNav(); navigate(currentPage); }
    }
    return true;
  } catch(e) {
    return false;
  }
}

// Schedule a debounced push (groups rapid saves into one)
function schedulePush() {
  clearTimeout(_syncTimer);
  _syncTimer = setTimeout(pushToCloud, 800);
}

// Start polling every 15s so all viewers see live updates
function startPolling() {
  if (!jsonbinReady()) return;
  clearInterval(_pollTimer);
  _pollTimer = setInterval(async () => {
    if (document.hidden) return;   // skip when tab not visible
    const changed = await pullFromCloud(true);
    if (changed && currentUser) {
      applyLeagueSettings();
      buildNav();
      navigate(currentPage);
    }
  }, 15000);
}

// Visual sync indicator in topbar
function showSyncBadge(state) {
  const el = document.getElementById("sync-badge");
  if (!el) return;
  const states = {
    saving: { text:"‚òÅÔ∏è Saving...",   color:"rgba(68,136,255,.8)"  },
    saved:  { text:"‚úì Synced",       color:"rgba(57,255,138,.8)"  },
    error:  { text:"‚ö†Ô∏è Sync error",  color:"rgba(255,68,102,.8)"  },
    loading:{ text:"‚è≥ Loading...",  color:"rgba(240,192,64,.8)"  },
    offline:{ text:"üì¥ Offline mode",color:"rgba(160,176,204,.6)" },
  };
  const s = states[state] || states.offline;
  el.textContent = s.text;
  el.style.background = s.color;
  el.style.display = "";
  if (state === "saved") setTimeout(()=>{ el.style.display="none"; }, 3000);
}

// Master save ‚Äî saves locally AND pushes to cloud
function saveState() {
  // Fast local save
  lsSet("yash_bundle", bundleState());
  // Push to shared cloud
  if (jsonbinReady()) {
    schedulePush();
  }
}

// ‚îÄ‚îÄ INITIAL LOAD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// 1. Immediately hydrate from localStorage cache (instant load)
const _cached = lsGet("yash_bundle", null);
if (_cached) {
  applyBundle(_cached);
} else {
  // First ever load ‚Äî no cache, merge extra teams from old LS keys
  mergeExtraTeams(lsGet(LS.extraTeams, []));
}

// ================================================================
// STANDINGS LOGIC
// ================================================================
function pts(t){ return t.won*3 + t.drawn; }
function gd(t){ return t.gf - t.ga; }

// Form guide ‚Äî last N results for a team
function getForm(teamId, n=5) {
  const completed = fixtures.filter(f=>f.status==="completed" && (f.home===teamId||f.away===teamId));
  return completed.slice(-n).map(f=>{
    const isHome = f.home===teamId;
    const gs = isHome?f.hs:f.as, ga = isHome?f.as:f.hs;
    if(gs>ga) return "W"; if(gs<ga) return "L"; return "D";
  });
}

// Card suspension checker ‚Äî returns {suspended, warning}
function getCardStatus(player) {
  if(player.rc>0) return {suspended:true,msg:"üü• Suspended (Red Card)"};
  if(player.yc>=2) return {suspended:false,warning:true,msg:"‚ö†Ô∏è 1 more yellow = suspension"};
  return {suspended:false,warning:false};
}

// MOTM helpers
function getMOTM(fid) { return motm[fid] || null; }
function setMOTM(fid, playerId) { motm[fid]=playerId; saveState(); }

// Prediction helpers
function getPrediction(fid, userId) {
  const key = fid+"_"+userId;
  return predictions[key] || null;
}
function setPrediction(fid, pick) {
  const key = fid+"_"+(currentUser.name);
  predictions[key]=pick;
  saveState();
}
function getPredictionCounts(fid) {
  const all = Object.entries(predictions).filter(([k])=>k.startsWith(fid+"_")).map(([,v])=>v);
  return {home:all.filter(v=>v==="home").length, draw:all.filter(v=>v==="draw").length, away:all.filter(v=>v==="away").length, total:all.length};
}

// Rating helpers
function getMyRating(fid, playerId) {
  const key = fid+"_"+playerId+"_"+(currentUser.name);
  return ratings[key] || 0;
}
function setRating(fid, playerId, val) {
  const key = fid+"_"+playerId+"_"+(currentUser.name);
  ratings[key]=val;
  saveState();
  navigate("social");
}
function getAvgRating(fid, playerId) {
  const prefix = fid+"_"+playerId+"_";
  const vals = Object.entries(ratings).filter(([k])=>k.startsWith(prefix)).map(([,v])=>v);
  if(!vals.length) return 0;
  return (vals.reduce((a,b)=>a+b,0)/vals.length).toFixed(1);
}

// Comment helpers
function getComments(fid) { return (comments[fid]||[]); }
function addComment(fid, text) {
  if(!text.trim()) return;
  if(!comments[fid]) comments[fid]=[];
  comments[fid].push({id:Date.now(), from:currentUser.name, role:currentUser.role, text:text.trim(), time:new Date().toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})});
  saveState();
  navigate("social");
}
function sorted() {
  return [...teams].sort((a,b)=>{
    if(pts(b)!==pts(a)) return pts(b)-pts(a);
    if(gd(b)!==gd(a)) return gd(b)-gd(a);
    if(b.gf!==a.gf) return b.gf-a.gf;
    return a.name.localeCompare(b.name);
  }).map((t,i)=>({...t,pos:i+1}));
}
function getTiebreak(teamId) {
  const s = sorted();
  const me = s.find(t=>t.id===teamId);
  if(!me) return null;
  if(me.pos===1) return {type:"top",msg:"üèÜ You're TOP of the league! Maintain your lead."};
  const above = s[me.pos-2];
  const pd = pts(above)-pts(me);
  const gdd = gd(above)-gd(me);
  if(pd===0 && gdd<=0) return {type:"equal",msg:`‚ö° Equal points with ${above.name}. You lead on GD!`};
  if(pd===0) return {type:"gd",msg:`‚öΩ Same points as ${above.name}. Need ${gdd+1} more GD to overtake.`};
  if(pd===1) return {type:"close",msg:`üî• Only 1 point behind ${above.name}. A WIN puts you AHEAD!`};
  return {type:"gap",msg:`üìä ${pd} pts behind ${above.name}. Win your next matches and improve GD.`};
}

// ================================================================
// ROUND ROBIN GENERATOR
// ================================================================
function generateRR(teamArr, dbl) {
  let ts = [...teamArr];
  if(ts.length%2!==0) ts.push({id:-1});
  const half=ts.length/2, rounds=ts.length-1;
  const res=[];
  let fid=1000;
  for(let r=0;r<rounds;r++){
    for(let m=0;m<half;m++){
      const h=ts[m],a=ts[ts.length-1-m];
      if(h.id!==-1&&a.id!==-1)
        res.push({id:fid++,home:h.id,away:a.id,date:"",time:leagueSettings.defaultTime||"20:00",hs:null,as:null,status:"upcoming",md:r+1});
    }
    const last=ts.pop();ts.splice(1,0,last);
  }
  if(dbl){
    const base=[...res];
    base.forEach(f=>res.push({...f,id:fid++,home:f.away,away:f.home,md:f.md+rounds}));
  }
  return res;
}

// ================================================================
// RENDER HELPERS
// ================================================================
function svg(path,size=18){
  return `<svg width="${size}" height="${size}" viewBox="0 0 24 24" fill="currentColor"><path d="${path}"/></svg>`;
}
const ICONS={
  home:"M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z",
  trophy:"M7 4V2h10v2h2c1.1 0 2 .9 2 2v2c0 2.8-1.8 5-4.3 5.8-1 1.3-2.2 2.2-3.7 2.5V18h2v2H9v-2h2v-1.7c-1.5-.3-2.8-1.2-3.7-2.5C4.8 13 3 10.8 3 8V6c0-1.1.9-2 2-2h2zm-2 4V6h2v5.5C5.8 10.7 5 9.4 5 8zm14 0c0 1.4-.8 2.7-2 3.5V6h2v2z",
  calendar:"M19 3h-1V1h-2v2H8V1H6v2H5C3.9 3 3 3.9 3 5v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM7 10h2v2H7zm4 0h2v2h-2zm4 0h2v2h-2z",
  users:"M16 11c1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3 1.34 3 3 3zm-8 0c1.66 0 3-1.34 3-3S9.66 5 8 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z",
  chart:"M5 9v12H1V9h4zm4-6v18H5V3h4zm6 8v10h-4V11h4zm4-5v15h-4V6h4z",
  bell:"M12 22c1.1 0 2-.9 2-2h-4c0 1.1.9 2 2 2zm6-6v-5c0-3.07-1.64-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5S10.5 3.17 10.5 4v.68C7.63 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2z",
  message:"M20 2H4C2.9 2 2 2.9 2 4v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 12H6l-2 2V4h16v10z",
  settings:"M19.14 12.94c.04-.3.06-.61.06-.94s-.02-.64-.07-.94l2.03-1.58a.49.49 0 00.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96a7.02 7.02 0 00-1.62-.94l-.36-2.54A.484.484 0 0014 2h-4c-.25 0-.46.18-.49.42l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.07.62-.07.94s.02.64.07.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.37 1.04.7 1.62.94l.36 2.54c.05.24.24.42.49.42h4c.25 0 .46-.18.49-.42l.36-2.54a6.9 6.9 0 001.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.21.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z",
  shield:"M12 2L4 5v6c0 5.55 3.84 10.74 8 12 4.16-1.26 8-6.45 8-12V5l-8-3z",
  star:"M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z",
  info:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z",
  x:"M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z",
  check:"M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z",
  plus:"M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z",
  edit:"M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04a1 1 0 000-1.41l-2.34-2.34a1 1 0 00-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z",
  trash:"M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z",
  moon:"M12 11.807A9.002 9.002 0 0 1 10.049 2a9.94 9.94 0 0 0-5.12 2.735c-3.905 3.905-3.905 10.237 0 14.142 3.906 3.906 10.237 3.905 14.143 0a9.946 9.946 0 0 0 2.735-5.119A9.003 9.003 0 0 1 12 11.807z",
  download:"M5 20h14v-2H5v2zm7-18L5.33 9h4.34v6h4.66V9h4.34L12 2z",
  refresh:"M17.65 6.35A7.958 7.958 0 0 0 12 4C7.58 4 4.01 7.58 4.01 12S7.58 20 12 20c3.73 0 6.84-2.55 7.73-6h-2.08A5.99 5.99 0 0 1 12 18c-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z",
  menu:"M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z",
  football:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 15.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 13v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z",
  logout:"M17 7l-1.41 1.41L18.17 11H8v2h10.17l-2.58 2.58L17 17l5-5-5-5zm-13 9V8h8V6H4C2.9 6 2 6.9 2 8v8c0 1.1.9 2 2 2h8v-2H4z",
};

function icon(name, size=17){ return svg(ICONS[name]||ICONS.star, size); }

function badge(t, size=34){
  const fs = Math.round(size*.3);
  const logo = teamLogos && teamLogos[t.id];
  if(logo) {
    return `<div class="tbadge" style="width:${size}px;height:${size}px;border:2px solid ${t.color}55;overflow:hidden;box-shadow:0 0 9px ${t.color}33;"><img src="${logo}" style="width:100%;height:100%;object-fit:cover;border-radius:50%;"/></div>`;
  }
  return `<div class="tbadge" style="width:${size}px;height:${size}px;background:radial-gradient(circle at 35% 35%,${t.color}55,${t.color}18);border:2px solid ${t.color}55;font-size:${fs}px;color:${t.color};box-shadow:0 0 9px ${t.color}33;">${t.short}</div>`;
}

function teamById(id){ return teams.find(t=>t.id===id)||{name:"?",short:"?",color:"#888"}; }

// ================================================================
// NAVIGATION
// ================================================================
const NAV_ITEMS = [
  {id:"dashboard",   icon:"home",     label:"Dashboard",     roles:["admin","manager","member","guest"]},
  {id:"standings",   icon:"trophy",   label:"Standings",     roles:["admin","manager","member","guest"]},
  {id:"fixtures",    icon:"calendar", label:"Fixtures",      roles:["admin","manager","member","guest"]},
  {id:"teams",       icon:"shield",   label:"Teams",         roles:["admin","manager","member","guest"]},
  {id:"squad",       icon:"users",    label:"Squad",         roles:["admin","manager","member"]},
  {id:"startingxi",  icon:"football", label:"Starting XI",   roles:["admin","manager","member"]},
  {id:"players",     icon:"star",     label:"Statistics",    roles:["admin","manager","member","guest"]},
  {id:"knockout",    icon:"trophy",   label:"Knockout Stage", roles:["admin","manager","member","guest"]},
  {id:"social",      icon:"message",  label:"Social Hub",    roles:["admin","manager","member","guest"]},
  {id:"lineup",      icon:"chart",    label:"Tactics Board", roles:["admin","manager"]},
  {id:"teamchat",    icon:"message",  label:"Team Chat",     roles:["admin","manager","member"],badge:"tc"},
  {id:"messages",    icon:"bell",     label:"Admin Messages",roles:["admin","manager"]},
  {id:"rules",       icon:"shield",   label:"Rules & Regs",  roles:["admin","manager","member","guest"]},
  {id:"customize",   icon:"settings", label:"Customize",     roles:["admin"]},
  {id:"admin",       icon:"settings", label:"Admin Panel",   roles:["admin"]},
];

function initApp() {
  applyLeagueSettings();
  document.getElementById("sb-avatar").textContent = currentUser.name[0].toUpperCase();
  document.getElementById("sb-uname").textContent = currentUser.name;
  document.getElementById("sb-urole").textContent = currentUser.role==="guest" ? "üëÅÔ∏è Guest Viewer" : currentUser.role.charAt(0).toUpperCase()+currentUser.role.slice(1);
  buildNav();

  if (jsonbinReady()) {
    // Pull fresh data from cloud, then show app
    showSyncBadge("loading");
    pullFromCloud(true).then(changed => {
      if (changed) { applyLeagueSettings(); buildNav(); }
      navigate("dashboard");
      startPolling();
    });
  } else {
    // No cloud configured ‚Äî offline mode
    showSyncBadge("offline");
    navigate("dashboard");
  }
}

function applyLeagueSettings() {
  // Theme
  document.body.classList.toggle("light-theme", leagueSettings.theme==="light");
  // Names
  const nameEl = document.getElementById("sb-league-name");
  const subEl = document.getElementById("sb-league-sub");
  const pillEl = document.getElementById("tb-league-pill");
  if(nameEl) nameEl.textContent = leagueSettings.name || "RAMADAN YASH";
  if(subEl) subEl.textContent = leagueSettings.subname || "LEAGUE 2026";
  if(pillEl) pillEl.textContent = "üåô " + (leagueSettings.subname || "LEAGUE 2026");
  // Title
  document.title = "üåô " + (leagueSettings.name||"Ramadan YASH League") + " " + (leagueSettings.subname||"2026");
}

function buildNav() {
  const unreadAdmin = messages.filter(m=>!m.read && m.to==="admin").length;
  const myTeamId = currentUser.teamId;
  const tcChat = myTeamId ? (teamchat[myTeamId]||[]) : [];
  // unread team chat = msgs not from current user, since last visit we just count recent
  const unreadTC = myTeamId ? tcChat.filter(m=>m.fromRole!==currentUser.role && m._unread).length : 0;
  const nav = document.getElementById("sb-nav");
  nav.innerHTML = NAV_ITEMS
    .filter(n=>n.roles.includes(currentUser.role))
    .map(n=>{
      const bdg = n.id==="messages" && unreadAdmin>0 ? unreadAdmin
                : n.id==="teamchat" && unreadTC>0 ? unreadTC : 0;
      return `<button class="nav-btn${currentPage===n.id?' active':''}" onclick="navigate('${n.id}')">
        ${icon(n.icon,17)} <span>${n.label}</span>
        ${bdg>0?`<span class="nav-badge">${bdg}</span>`:""}
      </button>`;
    }).join("");
  const tb = document.getElementById("tb-badge");
  if(unreadAdmin>0){ tb.style.display=""; tb.textContent=`üîî ${unreadAdmin} new`; }
  else tb.style.display="none";
}

function navigate(page) {
  currentPage = page;
  buildNav();
  const titles = {
    dashboard:"Dashboard",standings:"League Standings",fixtures:"Fixtures",
    teams:"Teams",players:"Statistics",lineup:"Tactics Board",
    messages:"Admin Messages",admin:"Admin Panel",
    squad:"Squad Manager",startingxi:"Starting XI",teamchat:"Team Chat",
    rules:"Rules & Regulations",knockout:"Knockout Stage",social:"Social Hub",
    customize:"Customize League",syncsetup:"Cloud Sync Setup",
  };
  document.getElementById("tb-title").textContent = (titles[page]||page).toUpperCase();
  const c = document.getElementById("content");
  c.innerHTML = `<div class="page">${renderPage(page)}</div>`;
  afterRender(page);
}

function renderPage(p) {
  switch(p) {
    case "dashboard":  return renderDashboard();
    case "standings":  return renderStandings();
    case "fixtures":   return renderFixtures();
    case "teams":      return renderTeams();
    case "squad":      return renderSquad();
    case "startingxi": return renderStartingXI();
    case "players":    return renderPlayers();
    case "lineup":     return renderLineup();
    case "teamchat":   return renderTeamChat();
    case "messages":   return renderMessages();
    case "admin":      return currentUser.role==="admin"?renderAdmin():"<p style='color:var(--red)'>Access denied.</p>";
    case "rules":      return renderRules();
    case "knockout":   return renderKnockout();
    case "social":     return renderSocial();
    case "customize":  return currentUser.role==="admin"?renderCustomize():"<p style='color:var(--red)'>Access denied.</p>";
    case "syncsetup":  return renderSyncSetup();
    default: return "<p>Page not found.</p>";
  }
}

// ================================================================
// PAGES
// ================================================================

// ---- DASHBOARD ----
function renderDashboard() {
  const s = sorted();
  const ls = leagueSettings;
  const lsInfo = (ls.startDate||ls.endDate||ls.venue) ? `
  <div style="background:rgba(240,192,64,.05);border:1px solid rgba(240,192,64,.15);border-radius:14px;padding:14px 18px;margin-bottom:20px;display:flex;flex-wrap:wrap;gap:16px;align-items:center;">
    ${ls.venue?`<span style="color:var(--gray2);font-size:13px;">üìç <strong style="color:var(--white);">${ls.venue}</strong></span>`:''}
    ${ls.startDate?`<span style="color:var(--gray2);font-size:13px;">üóìÔ∏è <strong style="color:var(--white);">${ls.startDate}</strong>${ls.endDate?' ‚Üí <strong style="color:var(--white);">'+ls.endDate+'</strong>':''}</span>`:''}
    ${ls.defaultTime?`<span style="color:var(--gray2);font-size:13px;">‚è∞ Default kickoff: <strong style="color:var(--white);">${ls.defaultTime}</strong></span>`:''}
    ${ls.matchDuration?`<span style="color:var(--gray2);font-size:13px;">‚åõ <strong style="color:var(--white);">${ls.matchDuration} min</strong> matches</span>`:''}
  </div>` : '';

  const upcoming = fixtures.filter(f=>f.status==="upcoming").slice(0,3);
  const recent = fixtures.filter(f=>f.status==="completed").slice(-3).reverse();
  const totalGoals = teams.reduce((a,t)=>a+t.gf,0);
  const played = fixtures.filter(f=>f.status==="completed").length;
  const upCount = fixtures.filter(f=>f.status==="upcoming").length;

  const tiebreakHtml = currentUser.teamId ? (() => {
    const tb = getTiebreak(currentUser.teamId);
    if(!tb) return "";
    const cols={top:"var(--gold)",equal:"var(--neon)",gd:"var(--blue)",close:"var(--orange)",gap:"var(--gray)"};
    const c=cols[tb.type]||"var(--gray)";
    return `<div class="card" style="border-color:${c}22">
      <div style="color:var(--gold);font-family:'Exo 2',sans-serif;font-weight:700;font-size:15px;margin-bottom:12px;">${icon("info",16)} üß† Smart Tie-Break Analysis</div>
      <div style="background:${c}11;border:1px solid ${c}2a;border-radius:10px;padding:12px 16px;display:flex;gap:10px;align-items:center;">
        <div style="color:${c};flex-shrink:0;">${icon("info",20)}</div>
        <div style="color:${c};font-weight:700;font-size:14px;">${tb.msg}</div>
      </div></div>`;
  })() : "";

  return `
  ${lsInfo}
  <div style="background:linear-gradient(135deg,rgba(240,192,64,.1),rgba(57,255,138,.05));border:1px solid rgba(240,192,64,.18);border-radius:20px;padding:22px 26px;margin-bottom:24px;position:relative;overflow:hidden;">
    <div style="position:absolute;right:22px;top:50%;transform:translateY(-50%);font-size:90px;opacity:.07;pointer-events:none;">üåô</div>
    <div style="font-family:'Exo 2',sans-serif;font-weight:900;font-size:24px;color:var(--gold);">ÿ±ŸÖÿ∂ÿßŸÜ ŸÖÿ®ÿßÿ±ŸÉ ‚Äî Ramadan Mubarak üèÜ</div>
    <div style="color:var(--gray2);margin-top:6px;font-size:14px;">Welcome to <strong style="color:var(--neon)">Ramadan YASH League 2026</strong> ‚Äî Season in full swing</div>
    <div style="display:flex;gap:14px;margin-top:18px;flex-wrap:wrap;">
      ${statBox("Teams",teams.length,"users","var(--gold)")}
      ${statBox("Played",played,"football","var(--neon)")}
      ${statBox("Goals",totalGoals,"star","var(--blue)")}
      ${statBox("Upcoming",upCount,"calendar","var(--orange)")}
    </div>
  </div>
  <div class="grid2">
    <div class="card">
      <div style="color:var(--gold);font-family:'Exo 2',sans-serif;font-weight:700;font-size:15px;margin-bottom:14px;">${icon("trophy",17)} STANDINGS</div>
      ${renderStandingsTable(s.slice(0,5),true)}
    </div>
    <div class="card">
      <div style="color:var(--gold);font-family:'Exo 2',sans-serif;font-weight:700;font-size:15px;margin-bottom:14px;">RECENT RESULTS</div>
      <div style="display:flex;flex-direction:column;gap:9px;">${recent.map(f=>renderFcard(f)).join("")}</div>
    </div>
    <div class="card">
      <div style="color:var(--neon);font-family:'Exo 2',sans-serif;font-weight:700;font-size:15px;margin-bottom:14px;">UPCOMING FIXTURES</div>
      <div style="display:flex;flex-direction:column;gap:9px;">${upcoming.map(f=>renderFcard(f)).join("")}</div>
    </div>
    <div class="card">
      <div style="color:var(--gold);font-family:'Exo 2',sans-serif;font-weight:700;font-size:15px;margin-bottom:14px;">${icon("bell",17)} ANNOUNCEMENTS</div>
      ${announcements.slice(0,2).map(a=>renderAnn(a)).join("")}
    </div>
    <div class="card">
      <div style="color:var(--gold);font-family:'Exo 2',sans-serif;font-weight:700;font-size:15px;margin-bottom:14px;">‚öΩ TOP SCORERS</div>
      ${renderScorersMini()}
    </div>
    ${tiebreakHtml}
  </div>`;
}

function statBox(lbl,val,icn,col) {
  return `<div class="card stat-box" style="padding:16px;min-width:120px;">
    <div style="display:flex;justify-content:space-between;align-items:flex-start;">
      <div>
        <div class="stat-lbl">${lbl}</div>
        <div class="stat-val" style="color:${col};">${val}</div>
      </div>
      <div style="color:${col};opacity:.4;">${icon(icn,26)}</div>
    </div></div>`;
}

// ---- STANDINGS ----
function renderStandings() {
  const s = sorted();
  const tiebreakHtml = currentUser.teamId ? (() => {
    const tb = getTiebreak(currentUser.teamId);
    if(!tb) return "";
    const c={top:"var(--gold)",equal:"var(--neon)",gd:"var(--blue)",close:"var(--orange)",gap:"var(--gray)"}[tb.type]||"var(--gray)";
    return `<div class="card mt16">
      <div style="color:var(--gold);font-weight:700;font-size:15px;margin-bottom:12px;">üß† Smart Tie-Break Analysis</div>
      <div style="background:${c}11;border:1px solid ${c}2a;border-radius:10px;padding:12px 16px;color:${c};font-weight:700;font-size:14px;">${tb.msg}</div>
    </div>`;
  })() : "";
  return `
  <div class="section-title">${icon("trophy",20)} League Standings</div>
  <div class="card" style="padding:0;overflow:hidden;">
    <div style="padding:16px 20px 12px;border-bottom:1px solid var(--navy4);display:flex;gap:18px;flex-wrap:wrap;">
      <div style="display:flex;align-items:center;gap:6px;"><div style="width:10px;height:10px;border-radius:2px;background:var(--gold);"></div><span style="color:var(--gray);font-size:12px;">Top Position</span></div>
      ${currentUser.teamId?`<div style="display:flex;align-items:center;gap:6px;"><div style="width:10px;height:10px;border-radius:2px;background:var(--neon);"></div><span style="color:var(--gray);font-size:12px;">Your Team</span></div>`:""}
    </div>
    <div style="padding:0 6px 14px;overflow-x:auto;">${renderStandingsTable(s,false)}</div>
  </div>
  ${tiebreakHtml}`;
}

function renderStandingsTable(s, compact) {
  const posCol={1:"var(--gold)",2:"#c0c8d8",3:"#cd7f32"};
  const rows = s.map(t=>{
    const isMe = t.id===currentUser.teamId;
    const pc = posCol[t.pos]||"var(--gray2)";
    const form = getForm(t.id, 5);
    const formHtml = compact ? "" : `<div style="display:flex;gap:3px;">${form.map(r=>`<span class="form-dot form-${r.toLowerCase()}">${r}</span>`).join("")}</div>`;
    return `<tr class="${isMe?"my-team":""}">
      <td><span style="color:${pc};font-weight:800;font-size:14px;">${t.pos}</span></td>
      <td class="left">
        <div style="display:flex;align-items:center;gap:9px;">
          ${badge(t,compact?26:32)}
          <span style="color:var(--white);font-weight:600;font-size:${compact?13:14}px;white-space:nowrap;">${t.name}</span>
          ${isMe?`<span class="tag tag-neon" style="font-size:9px;">YOU</span>`:""}
        </div>
      </td>
      <td>${t.played}</td>
      <td style="color:var(--neon);">${t.won}</td>
      <td>${t.drawn}</td>
      <td style="color:var(--red);">${t.lost}</td>
      <td>${t.gf}</td>
      <td>${t.ga}</td>
      <td style="color:${gd(t)>=0?"var(--neon)":"var(--red)"};">${gd(t)>0?"+":""}${gd(t)}</td>
      <td class="pts-cell">${pts(t)}</td>
      ${!compact?`<td>${formHtml}</td>`:""}
    </tr>`;
  }).join("");
  return `<table class="tbl">
    <thead><tr>
      <th>#</th><th class="left">Team</th><th>P</th><th>W</th><th>D</th><th>L</th>
      <th>GF</th><th>GA</th><th>GD</th><th>PTS</th>
      ${!compact?`<th>Form</th>`:""}
    </tr></thead><tbody>${rows}</tbody></table>`;
}

// ---- FIXTURES ----
function renderFixtures() {
  const mds = [...new Set(fixtures.map(f=>f.md))].sort((a,b)=>a-b);
  return `
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:22px;flex-wrap:wrap;gap:10px;">
    <div class="section-title" style="margin-bottom:0;">${icon("calendar",20)} Fixtures</div>
    <div style="display:flex;gap:8px;flex-wrap:wrap;" id="md-tabs">
      ${mds.map(d=>`<button class="btn btn-dark btn-sm md-tab" data-md="${d}" onclick="filterMD(${d})">MD ${d}</button>`).join("")}
    </div>
    ${currentUser.role==="admin"?`<button class="btn btn-neon btn-sm" onclick="openAutoFixture()">${icon("refresh",14)} Auto Generate</button>`:""}
  </div>
  <div id="fixtures-list"></div>`;
}

function filterMD(md) {
  document.querySelectorAll(".md-tab").forEach(b=>b.className="btn btn-dark btn-sm md-tab");
  document.querySelectorAll(`.md-tab[data-md="${md}"]`).forEach(b=>b.className="btn btn-gold btn-sm md-tab");
  const list = fixtures.filter(f=>f.md===md);
  document.getElementById("fixtures-list").innerHTML = list.map(f=>{
    const adminBtns = currentUser.role==="admin" ? `
      <div style="display:flex;gap:6px;flex-wrap:wrap;margin-top:8px;justify-content:center;">
        ${f.status==="upcoming"||f.status==="postponed" ? `<button class="btn btn-gold btn-xs" onclick="openEnterResult(${f.id})">${icon("check",12)} Enter Result</button>
        <button class="btn btn-xs" style="background:rgba(255,153,51,.15);border:1px solid rgba(255,153,51,.3);color:var(--orange);" onclick="openPostponeMatch(${f.id})">${icon("calendar",12)} Postpone</button>` : ""}
      </div>` : "";
    return `<div style="margin-bottom:9px;">${renderFcard(f)}${adminBtns?`<div style="text-align:center;">${adminBtns}</div>`:""}</div>`;
  }).join("");
}

function renderFcard(f) {
  const h=teamById(f.home), a=teamById(f.away);
  let scoreOrVs;
  if(f.status==="completed") {
    scoreOrVs = `<div class="fscore">${f.hs} ‚Äì ${f.as}</div>`;
  } else if(f.status==="postponed") {
    scoreOrVs = `<div class="fvs"><div class="ftime" style="color:var(--orange);">PPD</div><div class="fdate" style="color:var(--orange);">${f.date||"TBD"}</div></div>`;
  } else {
    scoreOrVs = `<div class="fvs"><div class="ftime">${f.time}</div><div class="fdate">${f.date||"TBD"}</div></div>`;
  }
  return `<div class="fcard">
    <div style="display:flex;align-items:center;gap:10px;flex:1;justify-content:flex-end;">
      <span class="fteam-name" style="color:var(--white);font-weight:700;font-size:14px;text-align:right;">${h.name}</span>
      ${badge(h,30)}
    </div>
    ${scoreOrVs}
    <div style="display:flex;align-items:center;gap:10px;flex:1;">
      ${badge(a,30)}
      <span class="fteam-name" style="color:var(--white);font-weight:700;font-size:14px;">${a.name}</span>
    </div>
  </div>`;
}

// ---- TEAMS ----
function renderTeams() {
  const canEdit = currentUser.role==="admin";
  return `
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:22px;flex-wrap:wrap;gap:10px;">
    <div class="section-title" style="margin-bottom:0;">${icon("shield",20)} Teams</div>
    ${canEdit?`<button class="btn btn-neon btn-sm" onclick="openAddTeam()">${icon("plus",14)} Add Team</button>`:""}
  </div>
  <div class="grid3">
    ${teams.map(t=>{
      const s=sorted().find(x=>x.id===t.id)||t;
      return `<div class="card card-sm" style="text-align:center;cursor:pointer;border-color:${t.color}22;" onclick="showTeamDetail(${t.id})">
        <div style="display:flex;justify-content:center;margin-bottom:12px;">${badge(t,54)}</div>
        <div style="color:var(--white);font-weight:700;font-size:14px;margin-bottom:3px;">${t.name}</div>
        <div style="color:var(--gray);font-size:12px;margin-bottom:12px;">P${t.played} ¬∑ <span style="color:var(--gold);">${pts(t)} pts</span></div>
        <div style="display:flex;justify-content:center;gap:16px;">
          <div><div style="color:var(--gold);font-weight:800;font-size:16px;">${t.won}</div><div style="color:var(--gray);font-size:10px;">W</div></div>
          <div><div style="color:var(--gray2);font-weight:700;font-size:16px;">${t.drawn}</div><div style="color:var(--gray);font-size:10px;">D</div></div>
          <div><div style="color:var(--red);font-weight:700;font-size:16px;">${t.lost}</div><div style="color:var(--gray);font-size:10px;">L</div></div>
        </div>
        ${canEdit?`<div style="margin-top:12px;display:flex;gap:6px;justify-content:center;">
          <button class="btn btn-dark btn-xs" onclick="event.stopPropagation();editTeam(${t.id})">${icon("edit",12)}</button>
          <button class="btn btn-red btn-xs" onclick="event.stopPropagation();deleteTeam(${t.id})">${icon("trash",12)}</button>
        </div>`:""}
      </div>`;
    }).join("")}
  </div>`;
}

// ---- PLAYERS ----
function renderPlayers() {
  const byGoals = [...players].sort((a,b)=>b.goals-a.goals);
  const byAssists = [...players].sort((a,b)=>b.assists-a.assists);

  // Count MOTM per player
  const motmCounts={};
  Object.values(motm).forEach(pid=>{ motmCounts[pid]=(motmCounts[pid]||0)+1; });

  // Suspension tracker
  const allSqPlayers=Object.values(squads).flat();
  const suspended=allSqPlayers.filter(p=>p.rc>0||p.yc>=2);
  const warnings=allSqPlayers.filter(p=>p.yc===1&&p.rc===0);

  return `
  <div class="section-title">${icon("star",20)} Player Statistics</div>
  ${(suspended.length>0||warnings.length>0)?`<div class="card" style="margin-bottom:20px;border-color:rgba(255,68,102,.25);">
    <div style="color:var(--red);font-weight:700;font-size:14px;margin-bottom:12px;">üö® Discipline Tracker</div>
    <div style="display:flex;flex-wrap:wrap;gap:8px;">
      ${suspended.map(p=>{
        const t=teamById(Math.floor(p.id/100));
        return `<div style="display:flex;align-items:center;gap:8px;padding:6px 10px;background:rgba(255,68,102,.08);border:1px solid rgba(255,68,102,.2);border-radius:8px;">
          ${badge(t,20)}<span style="color:var(--white);font-size:12px;font-weight:600;">${p.name}</span>
          <span class="suspended-tag">${p.rc>0?"üü• SUSPENDED":"‚ö†Ô∏è AT LIMIT"}</span>
        </div>`;
      }).join("")}
      ${warnings.map(p=>{
        const t=teamById(Math.floor(p.id/100));
        return `<div style="display:flex;align-items:center;gap:8px;padding:6px 10px;background:rgba(240,192,64,.06);border:1px solid rgba(240,192,64,.15);border-radius:8px;">
          ${badge(t,20)}<span style="color:var(--white);font-size:12px;font-weight:600;">${p.name}</span>
          <span class="warning-tag">üü® 1 YC</span>
        </div>`;
      }).join("")}
    </div>
  </div>`:""}
  <div class="grid2">
    <div class="card">
      <div style="color:var(--gold);font-weight:700;font-size:15px;margin-bottom:14px;">‚öΩ Top Scorers</div>
      ${byGoals.map((p,i)=>{
        const t=teamById(p.teamId);
        const mc=motmCounts[p.id]||0;
        return `<div style="display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:${i<players.length-1?"1px solid var(--navy4)":"none"}">
          <span style="color:${i<3?"var(--gold)":"var(--gray)"};font-weight:800;width:20px;text-align:center;">${i+1}</span>
          ${badge(t,26)}
          <div style="flex:1;"><div style="color:var(--white);font-weight:600;font-size:13px;">${p.name}</div><div style="color:var(--gray);font-size:11px;">${t.name} ¬∑ ${p.pos}</div></div>
          ${mc>0?`<span style="color:var(--gold);font-size:11px;" title="MOTM awards">‚≠ê√ó${mc}</span>`:""}
          <span style="color:var(--gold);font-weight:800;font-size:18px;font-family:'Exo 2',sans-serif;">${p.goals}</span>
          <span style="color:var(--gray);font-size:11px;">G</span>
          <span style="color:var(--neon);font-weight:700;font-size:15px;">${p.assists}</span>
          <span style="color:var(--gray);font-size:11px;">A</span>
        </div>`;
      }).join("")}
    </div>
    <div class="card">
      <div style="color:var(--neon);font-weight:700;font-size:15px;margin-bottom:14px;">üéØ Assist Leaders</div>
      ${byAssists.map((p,i)=>{
        const t=teamById(p.teamId);
        const cs=getCardStatus(p);
        return `<div style="display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:${i<players.length-1?"1px solid var(--navy4)":"none"}">
          <span style="color:${i<3?"var(--neon)":"var(--gray)"};font-weight:800;width:20px;text-align:center;">${i+1}</span>
          ${badge(t,26)}
          <div style="flex:1;"><div style="color:var(--white);font-weight:600;font-size:13px;">${p.name}</div><div style="color:var(--gray);font-size:11px;">${t.name}</div></div>
          ${cs.suspended?`<span class="suspended-tag">SUSP</span>`:cs.warning?`<span class="warning-tag">‚ö†Ô∏è</span>`:""}
          <span style="color:var(--neon);font-weight:800;font-size:18px;font-family:'Exo 2',sans-serif;">${p.assists}</span>
          <span style="color:var(--gold);font-size:11px;">üü®${p.yc}</span>
          ${p.rc>0?`<span style="color:var(--red);font-size:11px;">üü•${p.rc}</span>`:""}
        </div>`;
      }).join("")}
    </div>
  </div>`;
}

// ---- LINEUP ----
const FORMATIONS = {
  "2-3-1":[[{x:50,y:90,l:"GK",r:"gk"},{x:28,y:70,l:"LB",r:"df"},{x:72,y:70,l:"RB",r:"df"},{x:20,y:50,l:"LM",r:"mf"},{x:50,y:48,l:"CM",r:"mf"},{x:80,y:50,l:"RM",r:"mf"},{x:50,y:22,l:"ST",r:"fw"}]],
  "2-2-2":[[{x:50,y:90,l:"GK",r:"gk"},{x:28,y:72,l:"LB",r:"df"},{x:72,y:72,l:"RB",r:"df"},{x:30,y:52,l:"LM",r:"mf"},{x:70,y:52,l:"RM",r:"mf"},{x:32,y:24,l:"LST",r:"fw"},{x:68,y:24,l:"RST",r:"fw"}]],
  "1-3-2":[[{x:50,y:90,l:"GK",r:"gk"},{x:50,y:72,l:"CB",r:"df"},{x:20,y:52,l:"LM",r:"mf"},{x:50,y:50,l:"CM",r:"mf"},{x:80,y:52,l:"RM",r:"mf"},{x:33,y:24,l:"LST",r:"fw"},{x:67,y:24,l:"RST",r:"fw"}]],
  "3-2-1":[[{x:50,y:90,l:"GK",r:"gk"},{x:20,y:72,l:"LB",r:"df"},{x:50,y:74,l:"CB",r:"df"},{x:80,y:72,l:"RB",r:"df"},{x:32,y:52,l:"LM",r:"mf"},{x:68,y:52,l:"RM",r:"mf"},{x:50,y:22,l:"ST",r:"fw"}]],
};
const ROLE_COLORS = {gk:"#f0c040",df:"#4488ff",mf:"#39ff8a",fw:"#ff6633"};

function renderLineup() {
  const formations = Object.keys(FORMATIONS);
  const pos = FORMATIONS[tacticState.formation][0];
  const tactics = [
    {k:"attack",l:"Attack Level",c:"var(--neon)"},
    {k:"defense",l:"Defensive Depth",c:"var(--blue)"},
    {k:"press",l:"Press Intensity",c:"var(--gold)"},
    {k:"tempo",l:"Tempo",c:"var(--orange)"},
  ];
  const posHtml = pos.map((p,i)=>{
    const c=ROLE_COLORS[p.r];
    return `<div class="ppos" style="left:${p.x}%;top:${p.y}%;background:${c}22;border:2px solid ${c};color:${c};box-shadow:0 0 10px ${c}44;font-size:8px;font-weight:800;">
      ${p.l}</div>`;
  }).join("");

  const readOnly = currentUser.role==="member";
  return `
  <div class="section-title">${icon("football",20)} Lineup Builder</div>
  <div style="display:flex;gap:22px;flex-wrap:wrap;">
    <div>
      <div style="display:flex;gap:8px;margin-bottom:16px;flex-wrap:wrap;">
        ${formations.map(f=>`<button class="btn btn-sm ${tacticState.formation===f?"btn-gold":"btn-dark"}" onclick="setFormation('${f}')" ${readOnly?"disabled":""}>${f}</button>`).join("")}
      </div>
      <div class="pitch" style="width:260px;aspect-ratio:.7;position:relative;">
        <svg style="position:absolute;inset:0;width:100%;height:100%;" viewBox="0 0 100 143" preserveAspectRatio="none">
          <rect x="10" y="5" width="80" height="133" stroke="rgba(255,255,255,.14)" stroke-width=".8" fill="none"/>
          <line x1="10" y1="71.5" x2="90" y2="71.5" stroke="rgba(255,255,255,.1)" stroke-width=".6"/>
          <circle cx="50" cy="71.5" r="15" stroke="rgba(255,255,255,.1)" stroke-width=".6" fill="none"/>
          <rect x="30" y="5" width="40" height="20" stroke="rgba(255,255,255,.1)" stroke-width=".6" fill="none"/>
          <rect x="30" y="118" width="40" height="20" stroke="rgba(255,255,255,.1)" stroke-width=".6" fill="none"/>
          <circle cx="50" cy="15" r="1.5" fill="rgba(255,255,255,.15)"/>
          <circle cx="50" cy="128" r="1.5" fill="rgba(255,255,255,.15)"/>
        </svg>
        ${posHtml}
      </div>
    </div>
    <div style="flex:1;min-width:220px;">
      <div style="color:var(--gold);font-weight:700;font-size:15px;margin-bottom:16px;">TACTICAL SLIDERS</div>
      ${tactics.map(t=>`
        <div style="margin-bottom:18px;">
          <div style="display:flex;justify-content:space-between;margin-bottom:6px;">
            <span style="color:var(--gray2);font-size:13px;">${t.l}</span>
            <span style="color:${t.c};font-weight:800;font-size:15px;" id="val-${t.k}">${tacticState[t.k]}</span>
          </div>
          <div style="position:relative;height:6px;background:rgba(255,255,255,.07);border-radius:3px;">
            <div id="bar-${t.k}" style="width:${tacticState[t.k]}%;height:100%;background:linear-gradient(90deg,${t.c}66,${t.c});border-radius:3px;transition:width .15s;"></div>
          </div>
          <input type="range" min="0" max="100" value="${tacticState[t.k]}" ${readOnly?"disabled":""}
            oninput="updateTactic('${t.k}',this.value,'${t.c}')"
            style="width:100%;margin-top:-6px;opacity:0;cursor:${readOnly?"not-allowed":"pointer"};position:relative;z-index:2;"/>
        </div>
      `).join("")}
      ${!readOnly?`<div style="display:flex;gap:8px;margin-top:20px;">
        <button class="btn btn-gold btn-sm" onclick="saveTactics()">${icon("check",14)} Save Tactics</button>
        <button class="btn btn-ghost btn-sm" onclick="resetTactics()">${icon("refresh",14)} Reset</button>
      </div>`:""}
    </div>
  </div>`;
}

function setFormation(f){ tacticState.formation=f; navigate("lineup"); }
function updateTactic(k,v,c){
  tacticState[k]=+v;
  document.getElementById("val-"+k).textContent=v;
  document.getElementById("bar-"+k).style.width=v+"%";
}
function saveTactics(){ saveState(); showToast("‚úÖ Tactics saved successfully!"); }
function resetTactics(){ tacticState={...tacticState,attack:65,defense:50,press:70,tempo:55}; navigate("lineup"); }

// ---- SQUAD ----
function posClass(p){
  if(p==="GK") return "pos-gk";
  if(["CB","LB","RB","WB","LWB","RWB"].includes(p)) return "pos-df";
  if(["ST","LW","RW","CF","SS"].includes(p)) return "pos-fw";
  return "pos-mf";
}
function posColor(p){
  if(p==="GK") return "var(--gold)";
  if(["CB","LB","RB","WB","LWB","RWB"].includes(p)) return "var(--blue)";
  if(["ST","LW","RW","CF","SS"].includes(p)) return "#ff6633";
  return "var(--neon)";
}

function getMySquad(){
  const tid = currentUser.teamId;
  if(!tid) return null;
  if(!squads[tid]) squads[tid]=JSON.parse(JSON.stringify(DEFAULT_SQUADS[tid]||[]));
  return squads[tid];
}

function renderSquad(){
  // Admin sees all teams; manager/member see their team only
  const isAdmin = currentUser.role==="admin";
  const selectedTeamId = window._squadTeam || (isAdmin ? teams[0]?.id : currentUser.teamId);
  if(!selectedTeamId) return `<div style="color:var(--gray);">No team assigned.</div>`;
  const squad = squads[selectedTeamId] || [];
  const tm = teamById(selectedTeamId);
  const canEdit = isAdmin || currentUser.role==="manager";

  const teamPicker = isAdmin ? `
    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:20px;">
      ${teams.map(t=>`<button class="btn btn-sm ${selectedTeamId===t.id?"btn-gold":"btn-dark"}" onclick="setSquadTeam(${t.id})">${badge(t,20)} &nbsp;${t.name}</button>`).join("")}
    </div>` : "";

  const xiIds = Object.values((startingXI[selectedTeamId]||{}).slots||{});

  const rows = squad.map(p=>{
    const inXI = xiIds.includes(p.id);
    return `<div class="player-card${inXI?" in-xi":""}" onclick="${canEdit?`openEditPlayer(${selectedTeamId},${p.id})`:'void(0)'}">
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;">
        <div class="player-num" style="background:${posColor(p.pos)}22;color:${posColor(p.pos)};">#${p.number}</div>
        <div style="flex:1;">
          <div style="color:var(--white);font-weight:700;font-size:14px;">${p.name}</div>
          <div style="display:flex;align-items:center;gap:6px;margin-top:3px;">
            <span class="pos-chip ${posClass(p.pos)}">${p.pos}</span>
            <span style="color:var(--gray);font-size:11px;">${p.nationality||""}</span>
          </div>
        </div>
      </div>
      <div style="display:flex;gap:10px;flex-wrap:wrap;">
        <div style="text-align:center;min-width:32px;"><div style="color:var(--gold);font-weight:800;font-size:16px;">${p.goals}</div><div style="color:var(--gray);font-size:9px;">Goals</div></div>
        <div style="text-align:center;min-width:32px;"><div style="color:var(--neon);font-weight:700;font-size:16px;">${p.assists}</div><div style="color:var(--gray);font-size:9px;">Ast</div></div>
        <div style="text-align:center;min-width:32px;"><div style="color:var(--yellow,#ffcc00);font-weight:700;font-size:16px;">${p.yc}</div><div style="color:var(--gray);font-size:9px;">YC</div></div>
        <div style="text-align:center;min-width:32px;"><div style="color:var(--gold);font-weight:800;font-size:15px;">${p.rating}</div><div style="color:var(--gray);font-size:9px;">Rtg</div></div>
      </div>
    </div>`;
  }).join("");

  return `
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;flex-wrap:wrap;gap:10px;">
    <div class="section-title" style="margin-bottom:0;">${icon("users",20)} ${tm.name} Squad</div>
    <div style="display:flex;gap:8px;">
      ${canEdit?`<button class="btn btn-neon btn-sm" onclick="openAddPlayer(${selectedTeamId})">${icon("plus",14)} Add Player</button>`:""}
      <button class="btn btn-ghost btn-sm" onclick="navigate('startingxi')">${icon("football",14)} Pick Starting XI</button>
    </div>
  </div>
  ${teamPicker}
  <div style="margin-bottom:14px;padding:12px 16px;background:rgba(57,255,138,.05);border:1px solid rgba(57,255,138,.15);border-radius:12px;display:flex;gap:20px;flex-wrap:wrap;">
    <span style="color:var(--gray2);font-size:13px;">Total: <strong style="color:var(--white);">${squad.length}</strong></span>
    <span style="color:var(--gray2);font-size:13px;">In XI: <strong style="color:var(--neon);">${xiIds.length}/7</strong></span>
    ${["GK","CB","LB","RB","CM","ST"].map(p=>{ const c=squad.filter(x=>x.pos===p).length; return c>0?`<span style="color:var(--gray2);font-size:13px;"><span class="pos-chip ${posClass(p)}">${p}</span> ${c}</span>`:""; }).join("")}
  </div>
  <div class="squad-grid">${rows||`<div style="color:var(--gray);padding:20px;">No players in squad yet.</div>`}</div>`;
}

function setSquadTeam(id){ window._squadTeam=id; navigate("squad"); }

// ---- STARTING XI ----
const XI_FORMATIONS = {
  "2-3-1": [
    {pid:"gk",  x:50,y:88,l:"GK",  r:"gk"},
    {pid:"lb",  x:28,y:68,l:"LB",  r:"df"},{pid:"rb",x:72,y:68,l:"RB",r:"df"},
    {pid:"lm",  x:20,y:48,l:"LM",  r:"mf"},{pid:"cm",x:50,y:46,l:"CM",r:"mf"},{pid:"rm",x:80,y:48,l:"RM",r:"mf"},
    {pid:"st",  x:50,y:22,l:"ST",  r:"fw"},
  ],
  "2-2-2": [
    {pid:"gk",  x:50,y:88,l:"GK",r:"gk"},
    {pid:"lb",  x:28,y:70,l:"LB",r:"df"},{pid:"rb",x:72,y:70,l:"RB",r:"df"},
    {pid:"lm",  x:30,y:50,l:"LM",r:"mf"},{pid:"rm",x:70,y:50,l:"RM",r:"mf"},
    {pid:"lst", x:32,y:24,l:"LST",r:"fw"},{pid:"rst",x:68,y:24,l:"RST",r:"fw"},
  ],
  "1-3-2": [
    {pid:"gk",  x:50,y:88,l:"GK", r:"gk"},
    {pid:"cb",  x:50,y:70,l:"CB", r:"df"},
    {pid:"lm",  x:20,y:50,l:"LM", r:"mf"},{pid:"cm",x:50,y:48,l:"CM",r:"mf"},{pid:"rm",x:80,y:50,l:"RM",r:"mf"},
    {pid:"lst", x:33,y:24,l:"LST",r:"fw"},{pid:"rst",x:67,y:24,l:"RST",r:"fw"},
  ],
  "3-2-1": [
    {pid:"gk",  x:50,y:88,l:"GK", r:"gk"},
    {pid:"lb",  x:20,y:70,l:"LB", r:"df"},{pid:"cb",x:50,y:72,l:"CB",r:"df"},{pid:"rb",x:80,y:70,l:"RB",r:"df"},
    {pid:"lm",  x:32,y:50,l:"LM", r:"mf"},{pid:"rm",x:68,y:50,l:"RM",r:"mf"},
    {pid:"st",  x:50,y:22,l:"ST", r:"fw"},
  ],
};
const ROLE_COL = {gk:"var(--gold)",df:"var(--blue)",mf:"var(--neon)",fw:"#ff6633"};

function renderStartingXI(){
  const tid = window._xiTeam || currentUser.teamId || teams[0]?.id;
  if(!tid) return `<div style="color:var(--gray);">No team found.</div>`;
  const isAdmin = currentUser.role==="admin";
  const canEdit = isAdmin || currentUser.role==="manager";
  const squad = squads[tid] || [];
  const xi = startingXI[tid] || {formation:"2-3-1", slots:{}};
  const formation = xi.formation || "2-3-1";
  const slots = xi.slots || {};
  const positions = XI_FORMATIONS[formation] || XI_FORMATIONS["2-3-1"];
  const tm = teamById(tid);

  const teamPicker = isAdmin ? `<div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:18px;">${teams.map(t=>`<button class="btn btn-sm ${tid===t.id?"btn-gold":"btn-dark"}" onclick="setXITeam(${t.id})">${t.short}</button>`).join("")}</div>` : "";

  const formBtns = Object.keys(XI_FORMATIONS).map(f=>`<button class="btn btn-sm ${formation===f?"btn-gold":"btn-dark"}" ${!canEdit?"disabled":""} onclick="setXIFormation(${tid},'${f}')">${f}</button>`).join("");

  // Pitch slots
  const pitchSlots = positions.map(pos=>{
    const pid = slots[pos.pid];
    const player = pid ? squad.find(p=>p.id===pid) : null;
    const c = ROLE_COL[pos.r];
    if(player){
      return `<div class="xi-slot filled" style="left:${pos.x}%;top:${pos.y}%;background:radial-gradient(circle at 35% 35%,${c}44,${c}18);border-color:${c};box-shadow:0 0 14px ${c}44;"
        title="${player.name}" onclick="${canEdit?`openXIPicker('${pos.pid}',${tid})`:'void(0)'}">
        <div style="font-size:8px;font-weight:900;color:${c};text-shadow:0 0 6px ${c};">#${player.number}</div>
        <div style="font-size:6.5px;font-weight:700;color:${c};max-width:46px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${player.name.split(" ")[0]}</div>
      </div>`;
    }
    return `<div class="xi-slot" style="left:${pos.x}%;top:${pos.y}%;" title="Click to assign ${pos.l}"
      onclick="${canEdit?`openXIPicker('${pos.pid}',${tid})`:'void(0)'}">
      <div style="font-size:9px;color:rgba(255,255,255,.3);">${pos.l}</div>
    </div>`;
  }).join("");

  // Bench = squad not in XI
  const inXIids = Object.values(slots);
  const bench = squad.filter(p=>!inXIids.includes(p.id));

  return `
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:18px;flex-wrap:wrap;gap:10px;">
    <div class="section-title" style="margin-bottom:0;">${icon("football",20)} ${tm.name} ‚Äî Starting XI</div>
    ${canEdit?`<button class="btn btn-red btn-sm" onclick="clearXI(${tid})">${icon("x",13)} Clear XI</button>`:""}
  </div>
  ${teamPicker}
  <div style="display:flex;gap:10px;margin-bottom:18px;flex-wrap:wrap;">${formBtns}</div>
  <div style="display:flex;gap:24px;flex-wrap:wrap;align-items:flex-start;">
    <div style="flex:0 0 auto;">
      <div class="xi-pitch" style="width:min(320px,80vw);aspect-ratio:.68;position:relative;">
        <svg style="position:absolute;inset:0;width:100%;height:100%;" viewBox="0 0 100 147" preserveAspectRatio="none">
          <rect x="8" y="4" width="84" height="139" stroke="rgba(255,255,255,.12)" stroke-width=".7" fill="none"/>
          <line x1="8" y1="73.5" x2="92" y2="73.5" stroke="rgba(255,255,255,.09)" stroke-width=".6"/>
          <circle cx="50" cy="73.5" r="15" stroke="rgba(255,255,255,.09)" stroke-width=".6" fill="none"/>
          <rect x="28" y="4" width="44" height="22" stroke="rgba(255,255,255,.09)" stroke-width=".6" fill="none"/>
          <rect x="28" y="121" width="44" height="22" stroke="rgba(255,255,255,.09)" stroke-width=".6" fill="none"/>
          <rect x="38" y="4" width="24" height="10" stroke="rgba(255,255,255,.07)" stroke-width=".5" fill="none"/>
          <rect x="38" y="133" width="24" height="10" stroke="rgba(255,255,255,.07)" stroke-width=".5" fill="none"/>
          <circle cx="50" cy="14" r="1.5" fill="rgba(255,255,255,.12)"/>
          <circle cx="50" cy="133" r="1.5" fill="rgba(255,255,255,.12)"/>
        </svg>
        ${pitchSlots}
      </div>
      <div style="margin-top:10px;text-align:center;color:var(--gray);font-size:12px;">${inXIids.length}/7 selected${canEdit?" ¬∑ Click slot to assign":""}</div>
    </div>
    <div style="flex:1;min-width:240px;">
      <div style="color:var(--gold);font-weight:700;font-size:14px;margin-bottom:12px;">ü™ë Bench (${bench.length})</div>
      <div style="display:flex;flex-direction:column;gap:6px;max-height:380px;overflow-y:auto;">
        ${bench.length===0?`<div style="color:var(--gray);font-size:13px;">All players assigned to XI</div>`:
          bench.map(p=>`<div style="display:flex;align-items:center;gap:10px;padding:8px 12px;background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.06);border-radius:10px;">
            <div class="player-num" style="width:28px;height:28px;font-size:12px;background:${posColor(p.pos)}18;color:${posColor(p.pos)};">#${p.number}</div>
            <div style="flex:1;"><div style="color:var(--white);font-size:13px;font-weight:600;">${p.name}</div></div>
            <span class="pos-chip ${posClass(p.pos)}">${p.pos}</span>
          </div>`).join("")}
      </div>
    </div>
  </div>`;
}

function setXITeam(id){ window._xiTeam=id; navigate("startingxi"); }
function setXIFormation(tid, f){
  if(!startingXI[tid]) startingXI[tid]={formation:f,slots:{}};
  startingXI[tid].formation=f;
  startingXI[tid].slots={};
  saveState(); navigate("startingxi");
}
function clearXI(tid){
  if(!startingXI[tid]) startingXI[tid]={formation:"2-3-1",slots:{}};
  startingXI[tid].slots={};
  saveState(); navigate("startingxi");
}

function openXIPicker(posId, tid){
  const squad = squads[tid]||[];
  const xi = startingXI[tid]||{formation:"2-3-1",slots:{}};
  const usedIds = Object.values(xi.slots||{});
  const available = squad.filter(p=>!usedIds.includes(p.id));
  modal(`
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:18px;">
    <div style="color:var(--gold);font-weight:800;font-size:18px;font-family:'Exo 2',sans-serif;">Assign Player ‚Äî <span style="color:var(--neon);">${posId.toUpperCase()}</span></div>
    <button class="btn btn-dark btn-xs" onclick="closeModalBtn()">${icon("x",16)}</button>
  </div>
  ${xi.slots[posId]?`<button class="btn btn-red btn-sm" style="margin-bottom:12px;" onclick="removeXISlot('${posId}',${tid})">${icon("x",13)} Remove current player</button>`:""}
  <div style="display:flex;flex-direction:column;gap:6px;max-height:380px;overflow-y:auto;">
    ${available.length===0?`<div style="color:var(--gray);">All available players are assigned. Clear other slots first.</div>`:
      available.map(p=>`<div onclick="assignXISlot('${posId}',${p.id},${tid})" style="display:flex;align-items:center;gap:12px;padding:10px 14px;background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.07);border-radius:10px;cursor:pointer;" onmouseover="this.style.background='rgba(240,192,64,.08)'" onmouseout="this.style.background='rgba(255,255,255,.03)'">
        <div class="player-num" style="width:32px;height:32px;background:${posColor(p.pos)}22;color:${posColor(p.pos)};">#${p.number}</div>
        <div style="flex:1;"><div style="color:var(--white);font-weight:600;font-size:14px;">${p.name}</div><div style="color:var(--gray);font-size:11px;">${p.nationality||""} ¬∑ Age ${p.age||"‚Äî"}</div></div>
        <div style="text-align:right;">
          <span class="pos-chip ${posClass(p.pos)}">${p.pos}</span>
          <div style="color:var(--gold);font-size:12px;font-weight:700;margin-top:3px;">‚öΩ${p.goals} üéØ${p.assists}</div>
        </div>
      </div>`).join("")}
  </div>`);
}
function assignXISlot(posId, playerId, tid){
  if(!startingXI[tid]) startingXI[tid]={formation:"2-3-1",slots:{}};
  startingXI[tid].slots[posId]=playerId;
  saveState(); closeModalBtn(); navigate("startingxi");
}
function removeXISlot(posId, tid){
  if(startingXI[tid]&&startingXI[tid].slots) delete startingXI[tid].slots[posId];
  saveState(); closeModalBtn(); navigate("startingxi");
}

// ---- SQUAD ADD/EDIT ----
function openAddPlayer(tid){
  modal(`
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:18px;">
    <div style="color:var(--gold);font-weight:800;font-size:18px;font-family:'Exo 2',sans-serif;">Add Player</div>
    <button class="btn btn-dark btn-xs" onclick="closeModalBtn()">${icon("x",16)}</button>
  </div>
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:14px;">
    <div><label class="inp-label">Full Name</label><input id="ap-name" class="inp" placeholder="Player name"/></div>
    <div><label class="inp-label">Shirt Number</label><input id="ap-num" class="inp" type="number" min="1" max="99" placeholder="9"/></div>
    <div><label class="inp-label">Position</label>
      <select id="ap-pos" class="inp" style="cursor:pointer;">
        ${["GK","CB","LB","RB","LWB","RWB","CDM","CM","CAM","LM","RM","LW","RW","CF","ST"].map(p=>`<option value="${p}">${p}</option>`).join("")}
      </select>
    </div>
    <div><label class="inp-label">Nationality</label><input id="ap-nat" class="inp" placeholder="Saudi"/></div>
    <div><label class="inp-label">Age</label><input id="ap-age" class="inp" type="number" min="15" max="45" placeholder="22"/></div>
    <div><label class="inp-label">Rating (1‚Äì10)</label><input id="ap-rat" class="inp" type="number" min="1" max="10" step="0.1" placeholder="7.0"/></div>
  </div>
  <button class="btn btn-gold btn-md" onclick="saveNewPlayer(${tid})">${icon("check",16)} Add to Squad</button>`);
}
function saveNewPlayer(tid){
  const name=document.getElementById("ap-name").value.trim();
  const num=parseInt(document.getElementById("ap-num").value)||0;
  const pos=document.getElementById("ap-pos").value;
  const nat=document.getElementById("ap-nat").value.trim();
  const age=parseInt(document.getElementById("ap-age").value)||20;
  const rating=parseFloat(document.getElementById("ap-rat").value)||7.0;
  if(!name){showToast("‚ö†Ô∏è Name required."); return;}
  if(!squads[tid]) squads[tid]=[];
  const newId = Date.now();
  squads[tid].push({id:newId,name,number:num,pos,nationality:nat,age,rating,goals:0,assists:0,yc:0,rc:0});
  // Also add to global players stats list so they appear in Statistics page
  players.push({id:newId,name,teamId:tid,pos,goals:0,assists:0,yc:0,rc:0,rating});
  saveState(); closeModalBtn(); showToast(`‚úÖ ${name} added to squad!`); navigate("squad");
}
function openEditPlayer(tid,pid){
  const sq=squads[tid]||[];
  const p=sq.find(x=>x.id===pid);
  if(!p) return;
  const canDelete = currentUser.role==="admin"||currentUser.role==="manager";
  modal(`
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:18px;">
    <div style="color:var(--gold);font-weight:800;font-size:18px;font-family:'Exo 2',sans-serif;">Edit Player</div>
    <div style="display:flex;gap:8px;">
      ${canDelete?`<button class="btn btn-red btn-xs" onclick="deletePlayer(${tid},${pid})">${icon("trash",14)}</button>`:""}
      <button class="btn btn-dark btn-xs" onclick="closeModalBtn()">${icon("x",16)}</button>
    </div>
  </div>
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:14px;">
    <div><label class="inp-label">Full Name</label><input id="ep-name" class="inp" value="${p.name}"/></div>
    <div><label class="inp-label">Shirt #</label><input id="ep-num" class="inp" type="number" value="${p.number}"/></div>
    <div><label class="inp-label">Position</label>
      <select id="ep-pos" class="inp">
        ${["GK","CB","LB","RB","LWB","RWB","CDM","CM","CAM","LM","RM","LW","RW","CF","ST"].map(pp=>`<option value="${pp}"${pp===p.pos?" selected":""}>${pp}</option>`).join("")}
      </select>
    </div>
    <div><label class="inp-label">Nationality</label><input id="ep-nat" class="inp" value="${p.nationality||""}"/></div>
    <div><label class="inp-label">Goals</label><input id="ep-goals" class="inp" type="number" value="${p.goals}"/></div>
    <div><label class="inp-label">Assists</label><input id="ep-ast" class="inp" type="number" value="${p.assists}"/></div>
    <div><label class="inp-label">Yellow Cards</label><input id="ep-yc" class="inp" type="number" value="${p.yc}"/></div>
    <div><label class="inp-label">Rating</label><input id="ep-rat" class="inp" type="number" step="0.1" value="${p.rating}"/></div>
  </div>
  <button class="btn btn-gold btn-md" onclick="saveEditPlayer(${tid},${pid})">${icon("check",16)} Save Changes</button>`);
}
function saveEditPlayer(tid,pid){
  squads[tid]=squads[tid].map(p=>p.id===pid?{
    ...p,
    name:document.getElementById("ep-name").value.trim()||p.name,
    number:parseInt(document.getElementById("ep-num").value)||p.number,
    pos:document.getElementById("ep-pos").value,
    nationality:document.getElementById("ep-nat").value.trim(),
    goals:parseInt(document.getElementById("ep-goals").value)||0,
    assists:parseInt(document.getElementById("ep-ast").value)||0,
    yc:parseInt(document.getElementById("ep-yc").value)||0,
    rating:parseFloat(document.getElementById("ep-rat").value)||p.rating,
  }:p);
  // Sync updated stats to global players array
  const updated = squads[tid].find(p=>p.id===pid);
  if(updated){
    const gi = players.findIndex(p=>p.id===pid);
    if(gi>=0) players[gi]={...players[gi],name:updated.name,pos:updated.pos,goals:updated.goals,assists:updated.assists,yc:updated.yc,rc:updated.rc||0,rating:updated.rating};
    else players.push({id:pid,name:updated.name,teamId:tid,pos:updated.pos,goals:updated.goals,assists:updated.assists,yc:updated.yc,rc:updated.rc||0,rating:updated.rating});
  }
  saveState(); closeModalBtn(); showToast("‚úÖ Player updated!"); navigate("squad");
}
function deletePlayer(tid,pid){
  if(!confirm("Remove this player from the squad?")) return;
  squads[tid]=(squads[tid]||[]).filter(p=>p.id!==pid);
  // Remove from global stats players array too
  players = players.filter(p=>p.id!==pid);
  // remove from XI if present
  if(startingXI[tid]&&startingXI[tid].slots){
    Object.keys(startingXI[tid].slots).forEach(k=>{ if(startingXI[tid].slots[k]===pid) delete startingXI[tid].slots[k]; });
  }
  saveState(); closeModalBtn(); showToast("üóëÔ∏è Player removed."); navigate("squad");
}

// ---- TEAM CHAT ----
function renderTeamChat(){
  const tid = currentUser.teamId;
  if(!tid && currentUser.role!=="admin")
    return `<div class="card"><div style="color:var(--gray);">You are not assigned to a team.</div></div>`;

  // Admin: see all chats with team switcher
  const isAdmin = currentUser.role==="admin";
  const activeTid = window._tcTeam || tid || teams[0]?.id;
  const tm = teamById(activeTid);
  const chat = teamchat[activeTid]||[];

  const adminPicker = isAdmin ? `
    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:20px;">
      ${teams.map(t=>`<button class="btn btn-sm ${activeTid===t.id?"btn-gold":"btn-dark"}" onclick="setTCTeam(${t.id})">${badge(t,18)} &nbsp;${t.short}</button>`).join("")}
    </div>` : "";

  const fromName = isAdmin ? "Admin" : currentUser.name;
  const fromRole = currentUser.role;

  const bubbles = chat.map(m=>{
    const isMe = isAdmin ? m.fromRole==="admin" : m.from===fromName;
    return `<div style="display:flex;flex-direction:${isMe?"row-reverse":"row"};gap:8px;align-items:flex-end;">
      <div style="width:28px;height:28px;border-radius:50%;background:${isMe?"linear-gradient(135deg,rgba(240,192,64,.4),rgba(240,192,64,.1))":"rgba(255,255,255,.07)"};display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:800;flex-shrink:0;color:${isMe?"var(--gold)":"var(--gray2)"};">${m.from[0].toUpperCase()}</div>
      <div class="tc-bubble ${isMe?"tc-me":"tc-other"}">
        <div class="tc-name" style="color:${isMe?"var(--gold)":"var(--gray2)"};">${m.from} <span style="color:var(--gray);font-weight:400;text-transform:none;font-size:10px;">(${m.fromRole})</span></div>
        ${m.msg}
        <div class="tc-time">${m.time}</div>
      </div>
    </div>`;
  }).join("");

  return `
  <div style="display:flex;align-items:center;gap:12px;margin-bottom:18px;flex-wrap:wrap;">
    <div class="section-title" style="margin-bottom:0;">${icon("message",20)} ${isAdmin?"Team Chats":tm.name+" ¬∑ Team Chat"}</div>
    <div style="display:flex;align-items:center;gap:8px;padding:6px 12px;background:rgba(57,255,138,.08);border:1px solid rgba(57,255,138,.2);border-radius:20px;">
      <div style="width:7px;height:7px;border-radius:50%;background:var(--neon);box-shadow:0 0 6px var(--neon);"></div>
      <span style="color:var(--neon);font-size:11px;font-weight:700;">Team Only</span>
    </div>
  </div>
  ${adminPicker}
  <div class="card" style="padding:18px;">
    <div style="display:flex;align-items:center;gap:10px;margin-bottom:16px;padding-bottom:14px;border-bottom:1px solid var(--navy4);">
      ${badge(tm,36)}
      <div>
        <div style="color:var(--white);font-weight:700;font-size:15px;">${tm.name}</div>
        <div style="color:var(--gray);font-size:12px;">${(squads[activeTid]||[]).length} players ¬∑ Private team channel</div>
      </div>
    </div>
    <div class="tc-wrap">
      <div class="tc-msgs" id="tc-msgs">
        ${chat.length===0?`<div style="text-align:center;color:var(--gray);padding:30px;font-size:13px;">No messages yet. Start the conversation! üí¨</div>`:bubbles}
      </div>
      <div class="tc-bar">
        <input id="tc-inp" class="inp" placeholder="Message your team..." onkeydown="if(event.key==='Enter')sendTeamChatCurrent()"/>
        <button class="btn btn-gold btn-sm" onclick="sendTeamChatCurrent()">Send</button>
      </div>
    </div>
  </div>`;
  window._tcCurrentTid = activeTid;
}

function setTCTeam(id){ window._tcTeam=id; navigate("teamchat"); }
function sendTeamChatCurrent(){
  const tid = window._tcCurrentTid;
  const from = currentUser.role==="admin" ? "Admin" : currentUser.name;
  const role = currentUser.role;
  sendTeamChat(tid, from, role);
}
function sendTeamChat(tid, from, role){
  const inp=document.getElementById("tc-inp");
  if(!inp||!inp.value.trim()) return;
  if(!teamchat[tid]) teamchat[tid]=[];
  teamchat[tid].push({id:Date.now(),from,fromRole:role,msg:inp.value.trim(),time:new Date().toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})});
  inp.value="";
  saveState();
  navigate("teamchat");
}

// ---- MESSAGES (admin‚Üîmanager) ----
function renderMessages() {
  const isAdmin = currentUser.role==="admin";
  return `
  <div class="section-title">${icon("message",20)} Messages</div>
  <div class="card" style="max-width:600px;">
    <div class="chat-wrap">
      <div class="chat-msgs" id="chat-msgs" style="padding-right:6px;">
        ${messages.map(m=>{
          const isMe = isAdmin?(m.from==="Admin"):(m.from!=="Admin");
          return `<div style="display:flex;flex-direction:${isMe?"row-reverse":"row"};margin-bottom:14px;gap:8px;align-items:flex-end;">
            <div class="chat-bubble ${isMe?"chat-me":"chat-other"}">
              <div style="color:var(--gray);font-size:11px;margin-bottom:3px;">${m.from}</div>
              <div>${m.msg}</div>
              <div style="color:var(--gray);font-size:10px;margin-top:4px;text-align:right;">${m.time} ${m.read?"‚úì‚úì":"‚úì"}</div>
            </div>
          </div>`;
        }).join("")}
      </div>
      <div class="chat-bar">
        <input id="chat-inp" class="inp" placeholder="Type a message..." onkeydown="if(event.key==='Enter')sendMsg()"/>
        <button class="btn btn-gold btn-sm" onclick="sendMsg()">Send</button>
      </div>
    </div>
  </div>`;
}

function sendMsg(){
  const inp=document.getElementById("chat-inp");
  if(!inp||!inp.value.trim()) return;
  const from = currentUser.role==="admin"?"Admin":currentUser.name;
  messages.push({id:Date.now(),from,to:currentUser.role==="admin"?"all":"admin",msg:inp.value,time:"just now",read:false});
  saveState();
  inp.value="";
  navigate("messages");
}

// ---- ADMIN ----
function renderAdmin() {
  const unread = messages.filter(m=>!m.read&&m.to==="admin");
  const syncConfigured = jsonbinReady();
  return `
  <div class="section-title">${icon("settings",20)} Admin Control Panel</div>
  ${!syncConfigured ? `<div style="background:rgba(255,153,51,.1);border:2px solid rgba(255,153,51,.4);border-radius:16px;padding:20px;margin-bottom:20px;">
    <div style="color:var(--orange);font-family:'Exo 2',sans-serif;font-weight:800;font-size:16px;margin-bottom:10px;">üì¥ Cloud Sync Not Configured</div>
    <div style="color:var(--gray2);font-size:13px;line-height:1.7;margin-bottom:14px;">
      Changes you make are currently only visible on <strong style="color:var(--white);">your device</strong>.<br/>
      Follow the setup steps below to sync with all devices.
    </div>
    <button class="btn btn-sm" style="background:var(--orange);color:#040d1a;" onclick="navigate('syncsetup')">${icon("info",14)} View Setup Guide</button>
  </div>` : `<div style="background:rgba(57,255,138,.08);border:1px solid rgba(57,255,138,.25);border-radius:12px;padding:14px 18px;margin-bottom:20px;display:flex;align-items:center;gap:12px;">
    <div style="color:var(--neon);font-size:20px;">‚òÅÔ∏è</div>
    <div style="flex:1;"><div style="color:var(--neon);font-weight:700;font-size:14px;">Cloud Sync Active</div><div style="color:var(--gray);font-size:12px;">All changes sync to JSONBin ¬∑ Auto-refreshes every 15s</div></div>
    <button class="btn btn-dark btn-sm" onclick="pullFromCloud().then(()=>showToast('‚úÖ Refreshed from cloud!'))">${icon("refresh",13)} Pull Now</button>
  </div>`}
  <div class="grid2">
    <div class="card">
      <div style="color:var(--gold);font-weight:700;font-size:15px;margin-bottom:14px;">Quick Actions</div>
      <div style="display:flex;flex-direction:column;gap:10px;">
        <button class="btn btn-neon btn-md" onclick="openAutoFixture()">${icon("refresh",16)} ü§ñ Auto Generate Fixtures</button>
        <button class="btn btn-ghost btn-md" onclick="openAddTeam()">${icon("plus",16)} Add New Team</button>
        <button class="btn btn-ghost btn-md" onclick="openAnnouncement()">${icon("bell",16)} Post Announcement</button>
        <button class="btn btn-ghost btn-md">${icon("download",16)} Export Fixtures PDF</button>
        <hr style="border:none;border-top:1px solid var(--navy4);margin:4px 0;"/>
        <button class="btn btn-red btn-md" onclick="confirmResetLeague()" style="background:linear-gradient(135deg,rgba(255,68,102,.15),rgba(204,34,68,.1));color:var(--red);border:1px solid rgba(255,68,102,.3);">
          ${icon("refresh",16)} ‚ö†Ô∏è Reset All League Data
        </button>
      </div>
    </div>
    <div class="card">
      <div style="color:var(--gold);font-weight:700;font-size:15px;margin-bottom:14px;">League Overview</div>
      ${[["Teams",teams.length,"var(--gold)"],["Matches Played",fixtures.filter(f=>f.status==="completed").length,"var(--neon)"],["Upcoming",fixtures.filter(f=>f.status==="upcoming").length,"var(--blue)"],["Total Goals",teams.reduce((s,t)=>s+t.gf,0),"var(--orange)"]].map(([l,v,c])=>
        `<div style="display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid var(--navy4);">
          <span style="color:var(--gray2);font-size:14px;">${l}</span>
          <span style="color:${c};font-weight:800;font-family:'Exo 2',sans-serif;font-size:18px;">${v}</span>
        </div>`).join("")}
    </div>
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;">
        <div style="color:var(--gold);font-weight:700;font-size:15px;">Pending Requests</div>
        ${unread.length>0?`<span class="tag tag-neon">${unread.length} new</span>`:""}
      </div>
      ${unread.length===0?`<div style="color:var(--gray);font-size:13px;">No pending requests üéâ</div>`:
        unread.map(m=>`<div style="padding:10px 0;border-bottom:1px solid var(--navy4);">
          <div style="color:var(--white);font-size:13px;font-weight:600;">${m.from}</div>
          <div style="color:var(--gray2);font-size:12px;margin-top:3px;">${m.msg}</div>
          <div style="display:flex;gap:8px;margin-top:8px;">
            <button class="btn btn-neon btn-xs" onclick="approveMsg(${m.id})">${icon("check",12)} Approve</button>
            <button class="btn btn-red btn-xs" onclick="rejectMsg(${m.id})">${icon("x",12)} Reject</button>
          </div>
        </div>`).join("")}
    </div>
    <div class="card">
      <div style="color:var(--gold);font-weight:700;font-size:15px;margin-bottom:14px;">Credential Reference</div>
      <div style="overflow-x:auto;">
        <table class="cred-table">
          <thead><tr><th>Team</th><th>Manager Login</th><th>Member Login</th></tr></thead>
          <tbody>${TEAMS_DATA.map(t=>`<tr>
            <td style="color:${t.color};font-weight:700;">${t.name}</td>
            <td class="mono">${t.username}_mgr / ${t.mgr_pass}</td>
            <td class="mono">${t.username} / ${t.mem_pass}</td>
          </tr>`).join("")}
          <tr><td style="color:var(--gold);font-weight:700;">Admin</td><td class="mono" colspan="2">admin / yash2026</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>`;
}

// ---- ANNOUNCEMENTS ----
function renderAnn(a) {
  const styles={special:"ann ann-special",info:"ann ann-info",rule:"ann ann-rule"};
  const icns={special:"moon",info:"info",rule:"shield"};
  const cols={special:"var(--gold)",info:"var(--blue)",rule:"var(--neon)"};
  const c=cols[a.type]||cols.info;
  return `<div class="${styles[a.type]||styles.info}" style="margin-bottom:10px;">
    <div style="color:${c};margin-top:2px;flex-shrink:0;">${icon(icns[a.type]||"info",18)}</div>
    <div>
      <div style="color:${c};font-weight:700;font-size:14px;margin-bottom:4px;">${a.title}</div>
      <div style="color:var(--gray2);font-size:13px;line-height:1.5;">${a.body}</div>
      <div style="color:var(--gray);font-size:11px;margin-top:6px;">${a.date}</div>
    </div></div>`;
}

// ---- SCORERS MINI ----
function renderScorersMini() {
  return [...players].sort((a,b)=>b.goals-a.goals).slice(0,5).map((p,i)=>{
    const t=teamById(p.teamId);
    return `<div style="display:flex;align-items:center;gap:10px;padding:7px 0;border-bottom:${i<4?"1px solid var(--navy4)":"none"}">
      <span style="color:${i<3?"var(--gold)":"var(--gray)"};font-weight:800;width:20px;text-align:center;">${i+1}</span>
      ${badge(t,26)}
      <div style="flex:1;"><div style="color:var(--white);font-size:13px;font-weight:600;">${p.name}</div></div>
      <span style="color:var(--gold);font-weight:800;font-size:16px;">${p.goals}</span>
    </div>`;
  }).join("");
}

// ================================================================
// MODALS
// ================================================================
function modal(html) {
  document.getElementById("modal-container").innerHTML=`<div class="modal-bg" onclick="closeModal(event,this)"><div class="modal-box card" onclick="event.stopPropagation()">${html}</div></div>`;
}
function closeModal(e,bg){ if(e.target===bg) document.getElementById("modal-container").innerHTML=""; }
function closeModalBtn(){ document.getElementById("modal-container").innerHTML=""; }

// Enter Result
function openEnterResult(fid) {
  const f=fixtures.find(x=>x.id===fid);
  if(!f) return;
  const h=teamById(f.home), a=teamById(f.away);
  const allPlayers = [...(squads[f.home]||[]), ...(squads[f.away]||[])];
  const playerOpts = allPlayers.map(p=>`<option value="${p.id}">${p.name} (${teamById(p.teamId>=100?Math.floor(p.id/100):p.teamId).short||"?"})</option>`).join("");
  modal(`
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
    <div style="color:var(--gold);font-family:'Exo 2',sans-serif;font-weight:800;font-size:18px;">Enter Match Result</div>
    <button class="btn btn-dark btn-xs" onclick="closeModalBtn()">${icon("x",16)}</button>
  </div>
  <div style="display:flex;align-items:center;gap:16px;margin-bottom:22px;flex-wrap:wrap;">
    <div style="flex:1;text-align:center;">
      ${badge(h,44)}
      <div style="color:var(--white);font-weight:700;font-size:14px;margin-top:6px;">${h.name}</div>
      <input id="r-hs" type="number" min="0" max="20" value="0" class="inp" style="width:80px;text-align:center;font-size:24px;font-weight:800;color:var(--gold);margin-top:10px;"/>
    </div>
    <div style="color:var(--gray);font-weight:800;font-size:16px;">VS</div>
    <div style="flex:1;text-align:center;">
      ${badge(a,44)}
      <div style="color:var(--white);font-weight:700;font-size:14px;margin-top:6px;">${a.name}</div>
      <input id="r-as" type="number" min="0" max="20" value="0" class="inp" style="width:80px;text-align:center;font-size:24px;font-weight:800;color:var(--gold);margin-top:10px;"/>
    </div>
  </div>
  <div style="margin-bottom:16px;">
    <label class="inp-label">‚≠ê Man of the Match</label>
    <select id="r-motm" class="inp" style="cursor:pointer;">
      <option value="">‚Äî Select player ‚Äî</option>
      ${playerOpts}
    </select>
  </div>
  <div style="display:flex;gap:10px;">
    <button class="btn btn-gold btn-md" onclick="saveResult(${fid})">${icon("check",16)} Save Result</button>
    <button class="btn btn-ghost btn-md" onclick="closeModalBtn()">Cancel</button>
  </div>`);
}

function saveResult(fid) {
  const hs=parseInt(document.getElementById("r-hs").value)||0;
  const as_=parseInt(document.getElementById("r-as").value)||0;
  const motmSel = document.getElementById("r-motm");
  const motmId = motmSel ? parseInt(motmSel.value)||null : null;
  const fi=fixtures.findIndex(f=>f.id===fid);
  if(fi<0) return;
  const f=fixtures[fi];
  fixtures[fi]={...f,hs,as:as_,status:"completed"};
  // update standings
  teams=teams.map(t=>{
    if(t.id===f.home){
      return {...t,played:t.played+1,gf:t.gf+hs,ga:t.ga+as_,won:t.won+(hs>as_?1:0),drawn:t.drawn+(hs===as_?1:0),lost:t.lost+(hs<as_?1:0)};
    }
    if(t.id===f.away){
      return {...t,played:t.played+1,gf:t.gf+as_,ga:t.ga+hs,won:t.won+(as_>hs?1:0),drawn:t.drawn+(hs===as_?1:0),lost:t.lost+(as_<hs?1:0)};
    }
    return t;
  });
  saveState();

  // Save MOTM
  if(motmId) { motm[fid]=motmId; saveState(); }

  // Check if all matches played (league winner)
  const remaining = fixtures.filter(fx=>fx.status==="upcoming"||fx.status==="postponed").length;
  const hTeam=teamById(f.home), aTeam=teamById(f.away);
  let winnerBanner="";
  if(remaining===0){
    const leader=sorted()[0];
    winnerBanner=`<div style="margin-top:16px;padding:16px;background:linear-gradient(135deg,rgba(240,192,64,.2),rgba(57,255,138,.1));border:1px solid rgba(240,192,64,.4);border-radius:14px;text-align:center;">
      <div style="font-size:32px;">üèÜ</div>
      <div style="color:var(--gold);font-family:'Exo 2',sans-serif;font-weight:900;font-size:18px;margin-top:8px;">LEAGUE WINNER!</div>
      <div style="color:var(--white);font-weight:700;font-size:16px;margin-top:6px;">${leader.name}</div>
      <div style="color:var(--neon);font-size:13px;margin-top:4px;">${pts(leader)} pts ¬∑ ${leader.gf} goals scored</div>
    </div>`;
  }

  const resultWinner = hs>as_ ? `<span style="color:var(--neon);">üèÖ ${hTeam.name} win!</span>`
    : as_>hs ? `<span style="color:var(--neon);">üèÖ ${aTeam.name} win!</span>`
    : `<span style="color:var(--gold);">ü§ù Draw!</span>`;

  modal(`
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:18px;">
    <div style="color:var(--gold);font-family:'Exo 2',sans-serif;font-weight:800;font-size:18px;">‚úÖ Result Saved</div>
    <button class="btn btn-dark btn-xs" onclick="closeModalBtn();navigate(currentPage);">${icon("x",16)}</button>
  </div>
  <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;background:rgba(255,255,255,.03);border-radius:14px;padding:16px 20px;margin-bottom:12px;">
    <div style="text-align:center;flex:1;">
      ${badge(hTeam,42)}
      <div style="color:var(--white);font-weight:700;font-size:13px;margin-top:6px;">${hTeam.name}</div>
    </div>
    <div style="text-align:center;">
      <div style="background:rgba(240,192,64,.15);border:1px solid rgba(240,192,64,.3);border-radius:12px;padding:10px 20px;font-family:'Exo 2',sans-serif;font-weight:900;font-size:28px;color:var(--gold);">${hs} ‚Äì ${as_}</div>
      <div style="margin-top:8px;font-size:13px;">${resultWinner}</div>
    </div>
    <div style="text-align:center;flex:1;">
      ${badge(aTeam,42)}
      <div style="color:var(--white);font-weight:700;font-size:13px;margin-top:6px;">${aTeam.name}</div>
    </div>
  </div>
  <div style="color:var(--gray);font-size:12px;text-align:center;margin-bottom:8px;">${remaining} fixture${remaining===1?"":"s"} remaining</div>
  ${(()=>{
    if(!motmId) return "";
    const allP=[...(squads[f.home]||[]),...(squads[f.away]||[])];
    const mp=allP.find(p=>p.id===motmId);
    if(!mp) return "";
    return `<div class="motm-card" style="margin-bottom:12px;"><div style="font-size:24px;">‚≠ê</div><div style="color:var(--gold);font-weight:800;font-size:13px;margin-top:4px;">Man of the Match</div><div style="color:var(--white);font-weight:700;font-size:15px;">${mp.name}</div></div>`;
  })()}
  ${winnerBanner}
  <div style="margin-top:14px;text-align:center;">
    <button class="btn btn-gold btn-sm" onclick="closeModalBtn();navigate(currentPage);">${icon("check",14)} Done</button>
  </div>`);
}

// Auto Fixture Modal
function openAutoFixture() {
  const defTime = leagueSettings.defaultTime||"20:00";
  modal(`
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:22px;">
    <div style="color:var(--gold);font-family:'Exo 2',sans-serif;font-weight:800;font-size:18px;">ü§ñ Auto Fixture Generator</div>
    <button class="btn btn-dark btn-xs" onclick="closeModalBtn()">${icon("x",16)}</button>
  </div>
  <div style="margin-bottom:16px;">
    <label class="inp-label">Round Mode</label>
    <div style="display:flex;gap:10px;flex-wrap:wrap;">
      <button class="btn btn-gold btn-sm" id="mode-single" onclick="setMode('single')">Single Round Robin</button>
      <button class="btn btn-dark btn-sm" id="mode-double" onclick="setMode('double')">Double Round Robin</button>
    </div>
  </div>
  <div style="margin-bottom:16px;">
    <label class="inp-label">Start Date</label>
    <input type="date" id="af-start" class="inp" value="2026-04-01"/>
  </div>
  <div style="margin-bottom:16px;">
    <label class="inp-label">Match Days</label>
    <div style="display:flex;gap:8px;flex-wrap:wrap;" id="day-btns">
      ${["Mon","Tue","Wed","Thu","Fri","Sat","Sun"].map((d,i)=>`<button class="btn btn-sm ${d==="Fri"||d==="Sat"?"btn-gold":"btn-dark"} day-btn" data-d="${i}" onclick="toggleDay(this)">${d}</button>`).join("")}
    </div>
  </div>
  <div style="margin-bottom:22px;">
    <label class="inp-label">Match Time</label>
    <input type="time" id="af-time" class="inp" value="${defTime}" style="width:auto;"/>
  </div>
  <div style="display:flex;gap:10px;">
    <button class="btn btn-neon btn-md" onclick="doGenerate()">${icon("refresh",16)} Generate Fixtures</button>
    <button class="btn btn-ghost btn-md" onclick="closeModalBtn()">Cancel</button>
  </div>`);
  window._genMode="single";
}
function setMode(m){
  window._genMode=m;
  document.getElementById("mode-single").className=`btn btn-sm ${m==="single"?"btn-gold":"btn-dark"}`;
  document.getElementById("mode-double").className=`btn btn-sm ${m==="double"?"btn-gold":"btn-dark"}`;
}
function toggleDay(btn){
  btn.className=btn.className.includes("btn-gold")?"btn btn-sm btn-dark day-btn":"btn btn-sm btn-gold day-btn";
}
function doGenerate(){
  const gen=generateRR(teams,window._genMode==="double");
  const start=new Date(document.getElementById("af-start").value||"2026-04-01");
  const time=document.getElementById("af-time").value||"20:00";
  const selectedDays=[...document.querySelectorAll(".day-btn")].filter(b=>b.className.includes("btn-gold")).map(b=>+b.dataset.d);
  if(selectedDays.length===0){showToast("‚ö†Ô∏è Please select at least one match day.");return;}
  let dayIdx=0;
  const used=new Date(start);
  fixtures=gen.map((f,i)=>{
    while(!selectedDays.includes(used.getDay())){used.setDate(used.getDate()+1);}
    const d=used.toISOString().split("T")[0];
    used.setDate(used.getDate()+1);
    return {...f,date:d,time};
  });
  closeModalBtn();
  saveState();
  showToast(`‚úÖ Generated ${fixtures.length} fixtures!`);
  navigate("fixtures");
}

// Add Team
function openAddTeam(){
  modal(`
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
    <div style="color:var(--gold);font-weight:800;font-size:18px;font-family:'Exo 2',sans-serif;">Add New Team</div>
    <button class="btn btn-dark btn-xs" onclick="closeModalBtn()">${icon("x",16)}</button>
  </div>
  <div style="margin-bottom:14px;"><label class="inp-label">Team Name</label><input id="nt-name" class="inp" placeholder="e.g. Galaxy FC"/></div>
  <div style="margin-bottom:14px;"><label class="inp-label">Short Name (3 chars)</label><input id="nt-short" class="inp" placeholder="GFC" maxlength="4"/></div>
  <div style="margin-bottom:14px;"><label class="inp-label">Username</label><input id="nt-user" class="inp" placeholder="galaxy"/></div>
  <div style="margin-bottom:14px;"><label class="inp-label">Manager Password</label><input id="nt-mgr" class="inp" placeholder="mgr2026"/></div>
  <div style="margin-bottom:14px;"><label class="inp-label">Member Password</label><input id="nt-mem" class="inp" placeholder="galaxyfc"/></div>
  <div style="margin-bottom:22px;"><label class="inp-label">Team Color</label><input type="color" id="nt-color" value="#4488ff" style="width:60px;height:36px;border:none;background:none;cursor:pointer;"/></div>
  <div style="display:flex;gap:10px;">
    <button class="btn btn-gold btn-md" onclick="addTeam()">${icon("check",16)} Add Team</button>
    <button class="btn btn-ghost btn-md" onclick="closeModalBtn()">Cancel</button>
  </div>`);
}
function addTeam(){
  const name=document.getElementById("nt-name").value.trim();
  const short=document.getElementById("nt-short").value.trim().toUpperCase();
  const username=document.getElementById("nt-user").value.trim().toLowerCase();
  const mgr_pass=document.getElementById("nt-mgr").value.trim();
  const mem_pass=document.getElementById("nt-mem").value.trim();
  const color=document.getElementById("nt-color").value;
  if(!name||!short||!username){showToast("‚ö†Ô∏è Please fill all required fields.");return;}
  const newId=Math.max(...teams.map(t=>t.id))+1;
  teams.push({id:newId,name,short,color,username,mgr_pass,mem_pass,played:0,won:0,drawn:0,lost:0,gf:0,ga:0});
  TEAMS_DATA.push({id:newId,name,short,color,username,mgr_pass,mem_pass,played:0,won:0,drawn:0,lost:0,gf:0,ga:0});
  saveState();
  closeModalBtn();
  showToast(`‚úÖ Team "${name}" added!`);
  navigate("teams");
}

// Edit Team
function editTeam(id){
  const t=teams.find(x=>x.id===id);
  if(!t) return;
  modal(`
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
    <div style="color:var(--gold);font-weight:800;font-size:18px;font-family:'Exo 2',sans-serif;">Edit Team</div>
    <button class="btn btn-dark btn-xs" onclick="closeModalBtn()">${icon("x",16)}</button>
  </div>
  <div style="margin-bottom:14px;"><label class="inp-label">Team Name</label><input id="et-name" class="inp" value="${t.name}"/></div>
  <div style="margin-bottom:14px;"><label class="inp-label">Short Name</label><input id="et-short" class="inp" value="${t.short}" maxlength="4"/></div>
  <div style="margin-bottom:22px;"><label class="inp-label">Team Color</label><input type="color" id="et-color" value="${t.color}" style="width:60px;height:36px;border:none;background:none;cursor:pointer;"/></div>
  <div style="display:flex;gap:10px;">
    <button class="btn btn-gold btn-md" onclick="saveEditTeam(${id})">${icon("check",16)} Save</button>
    <button class="btn btn-ghost btn-md" onclick="closeModalBtn()">Cancel</button>
  </div>`);
}
function saveEditTeam(id){
  const name=document.getElementById("et-name").value.trim();
  const short=document.getElementById("et-short").value.trim().toUpperCase();
  const color=document.getElementById("et-color").value;
  teams=teams.map(t=>t.id===id?{...t,name,short,color}:t);
  saveState();
  closeModalBtn(); showToast("‚úÖ Team updated!"); navigate("teams");
}

function deleteTeam(id){
  if(!confirm(`Delete ${teamById(id).name}? This cannot be undone.`)) return;
  teams=teams.filter(t=>t.id!==id);
  saveState();
  showToast("üóëÔ∏è Team deleted.");
  navigate("teams");
}

// Team Detail
function showTeamDetail(id){
  const t=teamById(id);
  const tPlayers=players.filter(p=>p.teamId===id);
  const tbs=sorted().find(x=>x.id===id)||t;
  modal(`
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
    <div style="color:var(--gold);font-weight:800;font-size:18px;font-family:'Exo 2',sans-serif;">${t.name}</div>
    <button class="btn btn-dark btn-xs" onclick="closeModalBtn()">${icon("x",16)}</button>
  </div>
  <div style="display:flex;gap:16px;align-items:center;margin-bottom:20px;">
    ${badge(t,56)}
    <div>
      <div style="display:flex;gap:10px;margin-bottom:8px;">
        <div style="text-align:center;"><div style="color:var(--gold);font-weight:800;font-size:20px;">${tbs.played}</div><div style="color:var(--gray);font-size:11px;">P</div></div>
        <div style="text-align:center;"><div style="color:var(--neon);font-weight:800;font-size:20px;">${tbs.won}</div><div style="color:var(--gray);font-size:11px;">W</div></div>
        <div style="text-align:center;"><div style="color:var(--gray2);font-weight:800;font-size:20px;">${tbs.drawn}</div><div style="color:var(--gray);font-size:11px;">D</div></div>
        <div style="text-align:center;"><div style="color:var(--red);font-weight:800;font-size:20px;">${tbs.lost}</div><div style="color:var(--gray);font-size:11px;">L</div></div>
        <div style="text-align:center;"><div style="color:var(--gold);font-weight:800;font-size:22px;">${pts(tbs)}</div><div style="color:var(--gray);font-size:11px;">PTS</div></div>
      </div>
    </div>
  </div>
  <div style="color:var(--gold);font-size:14px;font-weight:700;margin-bottom:10px;">Squad</div>
  ${tPlayers.length===0?`<div style="color:var(--gray);">No player data</div>`:
    tPlayers.map(p=>`<div style="display:flex;justify-content:space-between;padding:7px 0;border-bottom:1px solid var(--navy4);">
      <span style="color:var(--white);font-size:13px;">${p.name} <span style="color:var(--gray);font-size:11px;">(${p.pos})</span></span>
      <span style="color:var(--gold);font-size:13px;">‚öΩ${p.goals} üéØ${p.assists}</span>
    </div>`).join("")}
  <div style="margin-top:16px;padding:12px;background:rgba(255,255,255,.03);border-radius:10px;">
    <div style="color:var(--gray);font-size:12px;">GF: <strong style="color:var(--gold);">${tbs.gf}</strong> &nbsp;|&nbsp; GA: <strong style="color:var(--red);">${tbs.ga}</strong> &nbsp;|&nbsp; GD: <strong style="color:${(tbs.gf-tbs.ga)>=0?"var(--neon)":"var(--red)"};">${tbs.gf-tbs.ga>0?"+":""}${tbs.gf-tbs.ga}</strong></div>
  </div>`);
}

// Announcement modal
function openAnnouncement(){
  modal(`
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
    <div style="color:var(--gold);font-weight:800;font-size:18px;font-family:'Exo 2',sans-serif;">Post Announcement</div>
    <button class="btn btn-dark btn-xs" onclick="closeModalBtn()">${icon("x",16)}</button>
  </div>
  <div style="margin-bottom:14px;"><label class="inp-label">Title</label><input id="an-title" class="inp" placeholder="Announcement title"/></div>
  <div style="margin-bottom:14px;"><label class="inp-label">Body</label><textarea id="an-body" class="inp" rows="3" style="resize:vertical;" placeholder="Message..."></textarea></div>
  <div style="margin-bottom:22px;">
    <label class="inp-label">Type</label>
    <select id="an-type" class="inp" style="cursor:pointer;">
      <option value="info">Info</option>
      <option value="special">Special (Ramadan)</option>
      <option value="rule">Rule Update</option>
    </select>
  </div>
  <button class="btn btn-gold btn-md" onclick="postAnn()">${icon("check",16)} Post</button>`);
}
function postAnn(){
  const title=document.getElementById("an-title").value.trim();
  const body=document.getElementById("an-body").value.trim();
  const type=document.getElementById("an-type").value;
  if(!title) return;
  announcements.unshift({id:Date.now(),title,body,date:new Date().toISOString().split("T")[0],type});
  saveState();
  closeModalBtn(); showToast("‚úÖ Announcement posted!"); navigate("dashboard");
}

function approveMsg(id){ messages=messages.map(m=>m.id===id?{...m,read:true}:m); saveState(); showToast("‚úÖ Approved."); navigate("admin"); }
function rejectMsg(id){ messages=messages.filter(m=>m.id!==id); saveState(); showToast("üóëÔ∏è Rejected."); navigate("admin"); }

// ================================================================
// RESET LEAGUE DATA
// ================================================================

function confirmResetLeague() {
  modal(`
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
    <div style="color:var(--red);font-family:'Exo 2',sans-serif;font-weight:800;font-size:18px;">‚ö†Ô∏è Reset All League Data</div>
    <button class="btn btn-dark btn-xs" onclick="closeModalBtn()">${icon("x",16)}</button>
  </div>
  <div style="background:rgba(255,68,102,.08);border:1px solid rgba(255,68,102,.2);border-radius:12px;padding:16px;margin-bottom:22px;">
    <div style="color:var(--red);font-weight:700;font-size:14px;margin-bottom:8px;">This will permanently reset:</div>
    <div style="color:var(--gray2);font-size:13px;line-height:1.9;">
      üóëÔ∏è All match results and scores<br/>
      üìä All team standings (W/D/L/GF/GA back to zero)<br/>
      üë§ All player statistics (goals, assists, cards back to zero)<br/>
      üìÖ All fixture changes (back to original schedule)<br/>
      üí¨ All messages, team chats and comments<br/>
      üì¢ All announcements (back to defaults)<br/>
      üèÜ Knockout bracket and predictions<br/>
      ‚≠ê All ratings and MOTM awards<br/>
      üèóÔ∏è Any newly added teams and players
    </div>
  </div>
  <div style="color:var(--gray);font-size:13px;margin-bottom:20px;">
    Credentials and team colours are <strong style="color:var(--gold)">not</strong> affected. Type <strong style="color:var(--red);">RESET</strong> below to confirm, then press the button.
  </div>
  <input id="reset-confirm-inp" class="inp" placeholder='Type  RESET  here' style="margin-bottom:16px;border-color:rgba(255,68,102,.3);font-weight:700;letter-spacing:2px;text-align:center;"/>
  <div style="display:flex;gap:10px;">
    <button class="btn btn-md" onclick="doResetLeague()" style="background:linear-gradient(135deg,#ff4466,#cc2244);color:#fff;">
      ${icon("refresh",16)} Reset Everything
    </button>
    <button class="btn btn-ghost btn-md" onclick="closeModalBtn()">Cancel</button>
  </div>`);
}

function doResetLeague() {
  const inp = document.getElementById("reset-confirm-inp");
  if (!inp || inp.value.trim().toUpperCase() !== "RESET") {
    if(inp){ inp.style.borderColor="var(--red)"; inp.placeholder="You must type RESET exactly"; inp.value=""; }
    return;
  }

  try {
    // Reset teams standings to zero (keep name/color/credentials)
    teams = teams.map(t=>({...t,played:0,won:0,drawn:0,lost:0,gf:0,ga:0}));

    // Reset fixtures back to defaults
    fixtures = JSON.parse(JSON.stringify(DEFAULT_FIXTURES));

    // Reset global players stats
    players = JSON.parse(JSON.stringify(DEFAULT_PLAYERS));

    // Reset announcements and messages
    announcements = JSON.parse(JSON.stringify(DEFAULT_ANNOUNCEMENTS));
    messages      = JSON.parse(JSON.stringify(DEFAULT_MESSAGES));

    // Reset tactics
    tacticState = {formation:"2-3-1",attack:65,defense:50,press:70,tempo:55};

    // Reset squads ‚Äî keep player names/positions but zero all stats
    const freshSquads = JSON.parse(JSON.stringify(DEFAULT_SQUADS));
    Object.keys(freshSquads).forEach(tid => {
      freshSquads[tid] = freshSquads[tid].map(p=>({...p,goals:0,assists:0,yc:0,rc:0,rating:7.0}));
    });
    squads = freshSquads;

    // Reset all social/game data
    startingXI  = {};
    teamchat    = {};
    predictions = {};
    ratings     = {};
    comments    = {};
    motm        = {};
    knockout    = {bracket:[],stage:"group",generated:false};

    // Remove any extra teams added during the season
    const originalIds = [1,2,3,4,5,6,7,8];
    const extraCount = TEAMS_DATA.filter(t=>!originalIds.includes(t.id)).length;
    TEAMS_DATA.splice(0, TEAMS_DATA.length, ...TEAMS_DATA.filter(t=>originalIds.includes(t.id)));
    teams = teams.filter(t=>originalIds.includes(t.id));

    // Wipe all local caches
    localStorage.clear();

    // Push clean state to cloud
    saveState();

    closeModalBtn();
    showToast(`‚úÖ League fully reset! ${extraCount>0?extraCount+" extra team(s) removed. ":""}All stats cleared.`);
    setTimeout(()=>navigate("dashboard"), 400);

  } catch(err) {
    console.error("Reset error:", err);
    showToast("‚ùå Reset failed: " + err.message);
  }
}

// ---- KNOCKOUT STAGE ----
function renderKnockout() {
  const isAdmin = currentUser.role==="admin";
  const s = sorted();
  const hasGroup = fixtures.some(f=>f.status==="completed");

  // Generate bracket from top 4 teams
  function getKOBracket() {
    return knockout.bracket || [];
  }

  function generateKnockout() {
    const top4 = s.slice(0,4);
    // SF: 1v4, 2v3
    knockout.bracket = [
      {id:"sf1",round:"Semi-Final 1",home:top4[0].id,away:top4[3].id,hs:null,as:null,status:"upcoming"},
      {id:"sf2",round:"Semi-Final 2",home:top4[1].id,away:top4[2].id,hs:null,as:null,status:"upcoming"},
      {id:"f1", round:"Final",       home:null,away:null,hs:null,as:null,status:"pending"},
    ];
    knockout.generated = true;
    saveState();
    navigate("knockout");
  }

  const bracket = getKOBracket();
  const sf1=bracket.find(b=>b.id==="sf1"), sf2=bracket.find(b=>b.id==="sf2"), fin=bracket.find(b=>b.id==="f1");

  // After both SFs done, populate final
  if(sf1&&sf1.status==="completed"&&sf2&&sf2.status==="completed"&&fin&&fin.status==="pending"){
    fin.home = sf1.hs>sf1.as?sf1.home:sf1.away;
    fin.away = sf2.hs>sf2.as?sf2.home:sf2.away;
    fin.status="upcoming";
    saveState();
  }

  function bMatchCard(bm) {
    if(!bm) return "";
    const h=bm.home?teamById(bm.home):{name:"TBD",short:"TBD",color:"#6a7fa0"};
    const a=bm.away?teamById(bm.away):{name:"TBD",short:"TBD",color:"#6a7fa0"};
    const isWin=bm.status==="completed";
    const hWin=isWin&&bm.hs>bm.as, aWin=isWin&&bm.as>bm.hs;
    return `<div class="bm ${isWin?'winner':''}">
      <div style="color:var(--gold);font-size:10px;font-weight:800;text-transform:uppercase;letter-spacing:1.5px;margin-bottom:8px;">${bm.round}</div>
      <div class="bm-team ${hWin?'winning':''}">
        ${bm.home?badge(h,24):`<div style="width:24px;height:24px;border-radius:50%;background:rgba(255,255,255,.06);border:1px dashed rgba(255,255,255,.2);"></div>`}
        <span style="color:${hWin?'var(--neon)':'var(--white)'};font-size:13px;font-weight:700;flex:1;">${h.name}</span>
        ${isWin?`<span class="bm-score" style="color:${hWin?'var(--neon)':'var(--gray2)'};">${bm.hs}</span>`:""}
      </div>
      <div class="bm-team ${aWin?'winning':''}">
        ${bm.away?badge(a,24):`<div style="width:24px;height:24px;border-radius:50%;background:rgba(255,255,255,.06);border:1px dashed rgba(255,255,255,.2);"></div>`}
        <span style="color:${aWin?'var(--neon)':'var(--white)'};font-size:13px;font-weight:700;flex:1;">${a.name}</span>
        ${isWin?`<span class="bm-score" style="color:${aWin?'var(--neon)':'var(--gray2)'};">${bm.as}</span>`:""}
      </div>
      ${isAdmin&&(bm.status==="upcoming")&&bm.home&&bm.away?`<button class="btn btn-gold btn-xs" style="width:100%;margin-top:10px;justify-content:center;" onclick="openKOResult('${bm.id}')">${icon("check",12)} Enter Result</button>`:""}
    </div>`;
  }

  // Champion display
  const champion = fin&&fin.status==="completed" ? (fin.hs>fin.as?teamById(fin.home):teamById(fin.away)) : null;

  return `
  <div class="section-title">${icon("trophy",20)} Knockout Stage</div>
  ${champion?`<div style="background:linear-gradient(135deg,rgba(240,192,64,.2),rgba(57,255,138,.08));border:2px solid rgba(240,192,64,.5);border-radius:20px;padding:24px;text-align:center;margin-bottom:24px;">
    <div style="font-size:48px;">üèÜ</div>
    <div style="font-family:'Exo 2',sans-serif;font-weight:900;font-size:24px;color:var(--gold);margin-top:8px;">CHAMPION!</div>
    <div style="display:flex;justify-content:center;margin:10px 0;">${badge(champion,56)}</div>
    <div style="color:var(--white);font-weight:700;font-size:20px;">${champion.name}</div>
    <div style="color:var(--neon);font-size:13px;margin-top:4px;">RYL 2026 Champions üéâ</div>
  </div>`:""}
  ${!knockout.generated?`
  <div class="card" style="text-align:center;padding:40px;">
    <div style="font-size:48px;margin-bottom:16px;">üèÜ</div>
    <div style="color:var(--white);font-weight:700;font-size:16px;margin-bottom:8px;">Knockout Stage Not Started</div>
    <div style="color:var(--gray);font-size:13px;margin-bottom:20px;">Top 4 teams from the group stage advance to Semi-Finals</div>
    <div style="margin-bottom:20px;">
      ${s.slice(0,4).map((t,i)=>`<div style="display:flex;align-items:center;gap:10px;padding:8px 16px;background:rgba(255,255,255,.03);border-radius:10px;margin-bottom:6px;max-width:300px;margin:6px auto;">
        <span style="color:var(--gold);font-weight:800;width:20px;">${i+1}</span>
        ${badge(t,28)}
        <span style="color:var(--white);font-weight:600;">${t.name}</span>
        <span style="color:var(--gold);margin-left:auto;font-weight:800;">${pts(t)} pts</span>
      </div>`).join("")}
    </div>
    ${isAdmin?`<button class="btn btn-gold btn-lg" onclick="generateKnockout()">${icon("trophy",16)} Generate Knockout Bracket</button>`:`<div style="color:var(--gray);font-size:13px;">Waiting for admin to generate bracket...</div>`}
  </div>`:`
  <div class="bracket-wrap">
    <div class="bracket">
      <div class="bracket-round" style="padding:0 12px;">
        <div class="bracket-round-title">Semi Finals</div>
        <div class="bracket-matches">
          ${bMatchCard(sf1)}
          ${bMatchCard(sf2)}
        </div>
      </div>
      <div style="display:flex;align-items:center;justify-content:center;padding:0 8px;color:var(--navy4);font-size:28px;">‚Üí</div>
      <div class="bracket-round" style="padding:0 12px;">
        <div class="bracket-round-title">Final</div>
        <div class="bracket-matches" style="justify-content:center;">
          ${bMatchCard(fin)}
        </div>
      </div>
    </div>
  </div>
  ${isAdmin?`<div style="margin-top:16px;"><button class="btn btn-dark btn-sm" onclick="if(confirm('Reset knockout bracket?')){knockout={bracket:[],stage:'group',generated:false};saveState();navigate('knockout');}">${icon("refresh",13)} Reset Bracket</button></div>`:""}`}`;
}

function generateKnockout(){
  const s=sorted();const top4=s.slice(0,4);
  knockout.bracket=[
    {id:"sf1",round:"Semi-Final 1",home:top4[0].id,away:top4[3].id,hs:null,as:null,status:"upcoming"},
    {id:"sf2",round:"Semi-Final 2",home:top4[1].id,away:top4[2].id,hs:null,as:null,status:"upcoming"},
    {id:"f1",round:"Final",home:null,away:null,hs:null,as:null,status:"pending"},
  ];
  knockout.generated=true;
  saveState();navigate("knockout");
}

function openKOResult(bmId){
  const bm=knockout.bracket.find(b=>b.id===bmId);
  if(!bm) return;
  const h=teamById(bm.home),a=teamById(bm.away);
  modal(`
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:18px;">
    <div style="color:var(--gold);font-weight:800;font-size:18px;">${bm.round} Result</div>
    <button class="btn btn-dark btn-xs" onclick="closeModalBtn()">${icon("x",16)}</button>
  </div>
  <div style="display:flex;align-items:center;gap:16px;margin-bottom:16px;flex-wrap:wrap;">
    <div style="flex:1;text-align:center;">${badge(h,44)}<div style="color:var(--white);font-weight:700;font-size:13px;margin-top:6px;">${h.name}</div>
      <input id="ko-hs" type="number" min="0" max="20" value="0" class="inp" style="width:80px;text-align:center;font-size:24px;font-weight:800;color:var(--gold);margin-top:8px;"/></div>
    <div style="color:var(--gray);font-weight:800;">VS</div>
    <div style="flex:1;text-align:center;">${badge(a,44)}<div style="color:var(--white);font-weight:700;font-size:13px;margin-top:6px;">${a.name}</div>
      <input id="ko-as" type="number" min="0" max="20" value="0" class="inp" style="width:80px;text-align:center;font-size:24px;font-weight:800;color:var(--gold);margin-top:8px;"/></div>
  </div>
  <div style="color:var(--gray);font-size:12px;margin-bottom:16px;">Note: No draws allowed in knockout. Higher score wins.</div>
  <button class="btn btn-gold btn-md" onclick="saveKOResult('${bmId}')">${icon("check",16)} Save</button>`);
}

function saveKOResult(bmId){
  const hs=parseInt(document.getElementById("ko-hs").value)||0;
  const as_=parseInt(document.getElementById("ko-as").value)||0;
  if(hs===as_){showToast("‚ö†Ô∏è No draws in knockout ‚Äî must have a winner!");return;}
  const bi=knockout.bracket.findIndex(b=>b.id===bmId);
  knockout.bracket[bi]={...knockout.bracket[bi],hs,as:as_,status:"completed"};
  // Populate final if both SFs done
  const sf1=knockout.bracket.find(b=>b.id==="sf1"),sf2=knockout.bracket.find(b=>b.id==="sf2"),fin=knockout.bracket.find(b=>b.id==="f1");
  if(sf1&&sf1.status==="completed"&&sf2&&sf2.status==="completed"&&fin&&fin.status==="pending"){
    fin.home=sf1.hs>sf1.as?sf1.home:sf1.away;
    fin.away=sf2.hs>sf2.as?sf2.home:sf2.away;
    fin.status="upcoming";
  }
  saveState();closeModalBtn();navigate("knockout");
}

// ---- SOCIAL HUB ----
function renderSocial() {
  const completed = fixtures.filter(f=>f.status==="completed");
  const upcoming = fixtures.filter(f=>f.status==="upcoming");
  const activeTab = window._socialTab||"predictions";

  const tabs = [
    {id:"predictions",label:"üéØ Predictions"},
    {id:"ratings",    label:"‚≠ê Player Ratings"},
    {id:"comments",   label:"üí¨ Match Comments"},
    {id:"motm",       label:"üèÖ Man of the Match"},
  ];

  const tabBar = `<div class="tab-bar">${tabs.map(t=>`<button class="tab-btn ${activeTab===t.id?"active":""}" onclick="window._socialTab='${t.id}';navigate('social')">${t.label}</button>`).join("")}</div>`;

  let content="";
  if(activeTab==="predictions"){
    const items = upcoming.slice(0,6);
    if(!items.length) {content=`<div class="card" style="text-align:center;padding:30px;color:var(--gray);">No upcoming fixtures to predict üéØ</div>`;}
    else {
      content = items.map(f=>{
        const h=teamById(f.home),a=teamById(f.away);
        const myPick=getPrediction(f.id, currentUser.name);
        const counts=getPredictionCounts(f.id);
        const total=counts.total||1;
        const hp=Math.round(counts.home/total*100),dp=Math.round(counts.draw/total*100),ap=Math.round(counts.away/total*100);
        return `<div class="card" style="margin-bottom:14px;">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;flex-wrap:wrap;gap:8px;">
            <div style="display:flex;align-items:center;gap:8px;">${badge(h,28)}<span style="color:var(--white);font-weight:700;">${h.name}</span></div>
            <span style="color:var(--gray);font-size:12px;">${f.date||"TBD"} ¬∑ MD${f.md}</span>
            <div style="display:flex;align-items:center;gap:8px;"><span style="color:var(--white);font-weight:700;">${a.name}</span>${badge(a,28)}</div>
          </div>
          ${currentUser.role!=="guest"?`<div style="display:flex;gap:8px;margin-bottom:12px;">
            <div class="pred-btn ${myPick==='home'?'selected':''}" onclick="setPrediction(${f.id},'home');navigate('social')">${badge(h,20)}<br/><span style="font-size:11px;">${h.short} Win</span></div>
            <div class="pred-btn ${myPick==='draw'?'selected-draw':''}" onclick="setPrediction(${f.id},'draw');navigate('social')">ü§ù<br/><span style="font-size:11px;">Draw</span></div>
            <div class="pred-btn ${myPick==='away'?'selected':''}" onclick="setPrediction(${f.id},'away');navigate('social')">${badge(a,20)}<br/><span style="font-size:11px;">${a.short} Win</span></div>
          </div>`:`<div style="color:var(--gray);font-size:12px;margin-bottom:10px;text-align:center;">Login to predict</div>`}
          ${counts.total>0?`<div style="display:flex;gap:6px;align-items:center;">
            <div style="flex:${hp};background:rgba(57,255,138,.3);height:6px;border-radius:3px;min-width:4px;" title="${hp}%"></div>
            <div style="flex:${dp};background:rgba(160,176,204,.3);height:6px;border-radius:3px;min-width:4px;" title="${dp}%"></div>
            <div style="flex:${ap};background:rgba(240,192,64,.3);height:6px;border-radius:3px;min-width:4px;" title="${ap}%"></div>
          </div>
          <div style="display:flex;justify-content:space-between;margin-top:4px;">
            <span style="color:var(--neon);font-size:10px;">${hp}% home</span>
            <span style="color:var(--gray2);font-size:10px;">${dp}% draw</span>
            <span style="color:var(--gold);font-size:10px;">${ap}% away</span>
          </div>`:""}
        </div>`;
      }).join("");
    }
  }

  if(activeTab==="ratings"){
    const recent = completed.slice(-4).reverse();
    if(!recent.length){content=`<div class="card" style="text-align:center;padding:30px;color:var(--gray);">No completed matches to rate yet ‚≠ê</div>`;}
    else {
      content = recent.map(f=>{
        const h=teamById(f.home),a=teamById(f.away);
        const allP=[...(squads[f.home]||[]),...(squads[f.away]||[])].slice(0,8);
        return `<div class="card" style="margin-bottom:14px;">
          <div style="display:flex;align-items:center;gap:10px;margin-bottom:14px;">
            ${badge(h,28)}<span style="color:var(--white);font-weight:700;">${h.name}</span>
            <span style="color:var(--gold);font-weight:800;font-family:'Exo 2',sans-serif;">${f.hs}‚Äì${f.as}</span>
            <span style="color:var(--white);font-weight:700;">${a.name}</span>${badge(a,28)}
          </div>
          ${allP.map(p=>{
            const avg=getAvgRating(f.id,p.id);
            const my=getMyRating(f.id,p.id);
            return `<div style="display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid var(--navy4);">
              <span style="color:${posColor(p.pos)};font-size:12px;font-weight:700;width:20px;text-align:center;">${p.number}</span>
              <span style="color:var(--white);font-size:13px;flex:1;">${p.name} <span style="color:var(--gray);font-size:11px;">(${p.pos})</span></span>
              ${avg>0?`<span style="color:var(--gold);font-weight:800;font-size:13px;">${avg}‚òÖ</span>`:""}
              ${currentUser.role!=="guest"?`<div style="display:flex;gap:2px;">${[1,2,3,4,5].map(s=>`<span onclick="setRating(${f.id},${p.id},${s})" style="cursor:pointer;font-size:16px;color:${my>=s?'var(--gold)':'rgba(255,255,255,.15)'};transition:color .15s;" onmouseover="this.style.color='var(--gold)'" onmouseout="this.style.color='${my>=s?'var(--gold)':'rgba(255,255,255,.15)'}'">‚òÖ</span>`).join("")}</div>`:`<span style="color:var(--gray);font-size:11px;">Log in to rate</span>`}
            </div>`;
          }).join("")}
        </div>`;
      }).join("");
    }
  }

  if(activeTab==="comments"){
    const recent=completed.slice(-5).reverse();
    if(!recent.length){content=`<div class="card" style="text-align:center;padding:30px;color:var(--gray);">No completed matches yet üí¨</div>`;}
    else {
      const selFid=window._commentFid||recent[0]?.id;
      const sf=recent.find(f=>f.id===selFid)||recent[0];
      const fComments=getComments(sf.id);
      content=`
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:16px;">
        ${recent.map(f=>{const h=teamById(f.home),a=teamById(f.away);return`<button class="btn btn-sm ${sf.id===f.id?'btn-gold':'btn-dark'}" onclick="window._commentFid=${f.id};navigate('social')">${h.short} ${f.hs}‚Äì${f.as} ${a.short}</button>`;}).join("")}
      </div>
      <div class="card">
        <div style="color:var(--gold);font-weight:700;margin-bottom:14px;">${teamById(sf.home).name} ${sf.hs}‚Äì${sf.as} ${teamById(sf.away).name}</div>
        <div style="max-height:320px;overflow-y:auto;margin-bottom:12px;">
          ${fComments.length===0?`<div style="color:var(--gray);text-align:center;padding:20px;font-size:13px;">Be first to comment! üí¨</div>`:
            fComments.map(c=>`<div class="comment-bubble">
              <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;">
                <div style="width:26px;height:26px;border-radius:50%;background:rgba(240,192,64,.2);display:flex;align-items:center;justify-content:center;font-weight:800;font-size:11px;color:var(--gold);">${c.from[0]}</div>
                <span style="color:var(--gold);font-weight:700;font-size:12px;">${c.from}</span>
                <span style="color:var(--gray);font-size:10px;margin-left:auto;">${c.time}</span>
              </div>
              <div style="color:var(--gray2);font-size:13px;">${c.text}</div>
            </div>`).join("")}
        </div>
        ${currentUser.role!=="guest"?`<div style="display:flex;gap:8px;">
          <input id="comment-inp" class="inp" placeholder="Add a comment..." onkeydown="if(event.key==='Enter'){addComment(${sf.id},document.getElementById('comment-inp').value);document.getElementById('comment-inp').value='';}"/>
          <button class="btn btn-gold btn-sm" onclick="addComment(${sf.id},document.getElementById('comment-inp').value);document.getElementById('comment-inp').value='';">Post</button>
        </div>`:`<div style="color:var(--gray);font-size:12px;text-align:center;">Log in to comment</div>`}
      </div>`;
    }
  }

  if(activeTab==="motm"){
    const matches=completed.filter(f=>motm[f.id]);
    const allMOTM=matches.map(f=>{
      const allP=[...(squads[f.home]||[]),...(squads[f.away]||[])];
      const p=allP.find(x=>x.id===motm[f.id]);
      return {fixture:f,player:p};
    }).filter(x=>x.player);
    // Count MOTM wins per player
    const counts={};
    allMOTM.forEach(({player})=>{counts[player.id]=(counts[player.id]||0)+1;});
    const topMOTM=Object.entries(counts).sort(([,a],[,b])=>b-a).slice(0,5).map(([pid,c])=>{
      const allSqPlayers=Object.values(squads).flat();
      const p=allSqPlayers.find(x=>x.id===parseInt(pid));
      return {player:p,count:c};
    }).filter(x=>x.player);
    content=`
    <div class="grid2">
      <div class="card">
        <div style="color:var(--gold);font-weight:700;margin-bottom:14px;">‚≠ê MOTM Leaderboard</div>
        ${topMOTM.length===0?`<div style="color:var(--gray);">No MOTM awards yet</div>`:
          topMOTM.map((x,i)=>{
            const t=teamById(x.player.teamId||Math.floor(x.player.id/100));
            return `<div style="display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid var(--navy4);">
              <span style="color:${i===0?'var(--gold)':'var(--gray)'};font-weight:800;width:20px;">${i+1}</span>
              ${badge(t,26)}
              <div style="flex:1;"><div style="color:var(--white);font-size:13px;font-weight:600;">${x.player.name}</div><div style="color:var(--gray);font-size:11px;">${t.name}</div></div>
              <span style="color:var(--gold);font-weight:800;">${x.count}√ó ‚≠ê</span>
            </div>`;
          }).join("")}
      </div>
      <div class="card">
        <div style="color:var(--gold);font-weight:700;margin-bottom:14px;">üèÖ Recent Awards</div>
        ${allMOTM.slice(-5).reverse().map(({fixture:f,player:p})=>{
          const h=teamById(f.home),a=teamById(f.away);
          const t=teamById(p.teamId||Math.floor(p.id/100));
          return `<div style="display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid var(--navy4);">
            <span style="font-size:18px;">‚≠ê</span>
            <div style="flex:1;"><div style="color:var(--white);font-size:13px;font-weight:600;">${p.name}</div><div style="color:var(--gray);font-size:11px;">${h.short} ${f.hs}‚Äì${f.as} ${a.short}</div></div>
            ${badge(t,26)}
          </div>`;
        }).join("")||`<div style="color:var(--gray);">No awards yet</div>`}
      </div>
    </div>`;
  }

  return `
  <div class="section-title">${icon("message",20)} Social Hub</div>
  ${tabBar}
  ${content}`;
}

// ---- CUSTOMIZE PAGE ----
function renderCustomize() {
  const ls = leagueSettings;
  return `
  <div class="section-title">${icon("settings",20)} Customize League</div>
  <div class="grid2">
    <div>
      <div class="settings-section">
        <div class="settings-title">üåô League Identity</div>
        <div style="margin-bottom:12px;"><label class="inp-label">League Name</label>
          <input id="cs-name" class="inp" value="${ls.name||'Ramadan YASH League'}" placeholder="League name"/></div>
        <div style="margin-bottom:12px;"><label class="inp-label">Season Tag (shown in sidebar)</label>
          <input id="cs-sub" class="inp" value="${ls.subname||'LEAGUE 2026'}" placeholder="e.g. LEAGUE 2026"/></div>
        <div style="margin-bottom:12px;"><label class="inp-label">Venue / Location</label>
          <input id="cs-venue" class="inp" value="${ls.venue||''}" placeholder="e.g. Al Wasl Stadium, Dubai"/></div>
        <div style="margin-bottom:14px;"><label class="inp-label">Description / Rules Summary</label>
          <textarea id="cs-desc" class="inp" rows="3" placeholder="Short description of the league...">${ls.description||''}</textarea></div>
        <button class="btn btn-gold btn-sm" onclick="saveLeagueIdentity()">${icon("check",14)} Save Identity</button>
      </div>

      <div class="settings-section">
        <div class="settings-title">üìÖ Season Dates</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:14px;">
          <div><label class="inp-label">Start Date</label>
            <input id="cs-start" type="date" class="inp" value="${ls.startDate||''}"/></div>
          <div><label class="inp-label">End Date</label>
            <input id="cs-end" type="date" class="inp" value="${ls.endDate||''}"/></div>
        </div>
        <div style="margin-bottom:14px;"><label class="inp-label">Default Match Time</label>
          <input id="cs-time" type="time" class="inp" value="${ls.defaultTime||'20:00'}"/></div>
        <div style="margin-bottom:14px;"><label class="inp-label">Match Duration (minutes)</label>
          <input id="cs-duration" type="number" class="inp" min="20" max="120" value="${ls.matchDuration||50}" placeholder="50"/></div>
        <button class="btn btn-gold btn-sm" onclick="saveLeagueDates()">${icon("check",14)} Save Dates & Times</button>
      </div>

      <div class="settings-section">
        <div class="settings-title">üé® Theme</div>
        <div style="display:flex;gap:10px;flex-wrap:wrap;">
          <button class="btn btn-sm ${(ls.theme||'dark')!=='light'?'btn-gold':'btn-dark'}" onclick="setTheme('dark')">üåô Dark Mode</button>
          <button class="btn btn-sm ${ls.theme==='light'?'btn-gold':'btn-dark'}" onclick="setTheme('light')">‚òÄÔ∏è Light Mode</button>
        </div>
      </div>
    </div>

    <div>
      <div class="settings-section">
        <div class="settings-title">üìã League Info Preview</div>
        <div style="background:rgba(240,192,64,.06);border:1px solid rgba(240,192,64,.2);border-radius:12px;padding:16px;margin-bottom:14px;">
          <div style="color:var(--gold);font-weight:800;font-size:16px;margin-bottom:4px;">${ls.name||'Ramadan YASH League'}</div>
          <div style="color:var(--neon);font-size:11px;font-weight:700;letter-spacing:2px;margin-bottom:10px;">${ls.subname||'LEAGUE 2026'}</div>
          ${ls.venue?`<div style="color:var(--gray2);font-size:13px;margin-bottom:6px;">üìç ${ls.venue}</div>`:''}
          ${ls.startDate||ls.endDate?`<div style="color:var(--gray2);font-size:13px;margin-bottom:6px;">üìÖ ${ls.startDate||'?'} ‚Üí ${ls.endDate||'?'}</div>`:''}
          ${ls.defaultTime?`<div style="color:var(--gray2);font-size:13px;margin-bottom:6px;">‚è∞ Default kickoff: ${ls.defaultTime}</div>`:''}
          ${ls.matchDuration?`<div style="color:var(--gray2);font-size:13px;margin-bottom:6px;">‚åõ Match duration: ${ls.matchDuration} minutes</div>`:''}
          ${ls.description?`<div style="color:var(--gray2);font-size:12px;margin-top:8px;line-height:1.6;">${ls.description}</div>`:''}
        </div>
        <div style="color:var(--gray);font-size:12px;">This info is visible on the Dashboard and Rules page.</div>
      </div>

      <div class="settings-section">
        <div class="settings-title">üõ°Ô∏è Team Logos</div>
        <div style="color:var(--gray);font-size:12px;margin-bottom:12px;">Upload a logo for each team (PNG/JPG, square recommended)</div>
        <div style="display:flex;flex-direction:column;gap:8px;max-height:380px;overflow-y:auto;">
          ${teams.map(t=>{
            const logo=teamLogos[t.id];
            return `<div style="display:flex;align-items:center;gap:10px;padding:9px 12px;background:rgba(255,255,255,.03);border-radius:10px;">
              ${logo
                ?`<img src="${logo}" style="width:38px;height:38px;border-radius:50%;object-fit:cover;border:2px solid ${t.color}55;"/>`
                :`<div style="width:38px;height:38px;border-radius:50%;background:${t.color}22;border:2px dashed ${t.color}55;display:flex;align-items:center;justify-content:center;font-weight:800;color:${t.color};font-size:11px;">${t.short}</div>`
              }
              <span style="color:var(--white);font-weight:600;flex:1;font-size:13px;">${t.name}</span>
              <label style="cursor:pointer;">
                <span class="btn btn-dark btn-xs">${icon("download",12)} Upload</span>
                <input type="file" accept="image/*" style="display:none;" onchange="uploadLogo(${t.id},this)"/>
              </label>
              ${logo?`<button class="btn btn-red btn-xs" onclick="removeLogo(${t.id})">${icon("x",12)}</button>`:""}
            </div>`;
          }).join("")}
        </div>
      </div>
    </div>
  </div>`;
}

function saveLeagueIdentity(){
  leagueSettings.name    = document.getElementById("cs-name").value.trim()||"Ramadan YASH League";
  leagueSettings.subname = document.getElementById("cs-sub").value.trim()||"LEAGUE 2026";
  leagueSettings.venue   = document.getElementById("cs-venue").value.trim();
  leagueSettings.description = document.getElementById("cs-desc").value.trim();
  saveState(); applyLeagueSettings(); showToast("‚úÖ League identity saved!"); navigate("customize");
}

function saveLeagueDates(){
  leagueSettings.startDate     = document.getElementById("cs-start").value;
  leagueSettings.endDate       = document.getElementById("cs-end").value;
  leagueSettings.defaultTime   = document.getElementById("cs-time").value||"20:00";
  leagueSettings.matchDuration = parseInt(document.getElementById("cs-duration").value)||50;
  saveState(); showToast("‚úÖ Dates & times saved!"); navigate("customize");
}

function setTheme(t){
  leagueSettings.theme=t;
  saveState(); applyLeagueSettings(); navigate("customize");
}

function uploadLogo(tid, input){
  const file=input.files[0];
  if(!file) return;
  const reader=new FileReader();
  reader.onload=e=>{
    teamLogos[tid]=e.target.result;
    saveState(); showToast("‚úÖ Logo uploaded!"); navigate("customize");
  };
  reader.readAsDataURL(file);
}

function removeLogo(tid){
  delete teamLogos[tid];
  saveState(); showToast("üóëÔ∏è Logo removed."); navigate("customize");
}

// ---- SYNC SETUP GUIDE ----
function renderSyncSetup() {
  const configured = jsonbinReady();
  const step = s => `<div style="display:flex;gap:14px;margin-bottom:20px;align-items:flex-start;">
    <div style="width:28px;height:28px;border-radius:50%;background:linear-gradient(135deg,var(--gold),var(--gold2));color:#040d1a;font-weight:900;font-size:13px;display:flex;align-items:center;justify-content:center;flex-shrink:0;margin-top:2px;">${s.n}</div>
    <div style="flex:1;">
      <div style="color:var(--white);font-weight:700;font-size:14px;margin-bottom:6px;">${s.title}</div>
      <div style="color:var(--gray2);font-size:13px;line-height:1.7;">${s.body}</div>
      ${s.code?`<div style="background:rgba(0,0,0,.4);border:1px solid rgba(255,255,255,.1);border-radius:8px;padding:10px 14px;margin-top:8px;font-family:monospace;font-size:12px;color:var(--neon);word-break:break-all;">${s.code}</div>`:""}
      ${s.img?`<div style="margin-top:8px;padding:10px;background:rgba(240,192,64,.06);border:1px solid rgba(240,192,64,.15);border-radius:8px;color:var(--gold);font-size:12px;">üì∏ ${s.img}</div>`:""}
    </div>
  </div>`;
  return `
  <div class="section-title">${icon("info",20)} Cloud Sync Setup Guide</div>
  ${configured?`<div style="background:rgba(57,255,138,.1);border:2px solid rgba(57,255,138,.3);border-radius:14px;padding:16px 20px;margin-bottom:24px;">
    <div style="color:var(--neon);font-weight:800;font-size:15px;">‚úÖ Cloud Sync is Active!</div>
    <div style="color:var(--gray2);font-size:13px;margin-top:4px;">Your app is connected to JSONBin. All changes sync across all devices automatically.</div>
  </div>` : `<div style="background:rgba(255,153,51,.08);border:2px solid rgba(255,153,51,.3);border-radius:14px;padding:16px 20px;margin-bottom:24px;">
    <div style="color:var(--orange);font-weight:800;font-size:15px;">‚öôÔ∏è Setup Required ‚Äî 5 Minutes</div>
    <div style="color:var(--gray2);font-size:13px;margin-top:4px;">Complete the steps below, then paste your keys into the HTML file and push to GitHub.</div>
  </div>`}
  <div class="card">
    <div style="color:var(--gold);font-weight:700;font-size:16px;margin-bottom:20px;">Step-by-Step Instructions</div>
    ${step({n:1,title:"Create a free JSONBin account",
      body:'Go to <strong style="color:var(--gold);">jsonbin.io</strong> and click <strong>Sign Up Free</strong>. No credit card needed.',
      img:"Open jsonbin.io in a new tab"})}
    ${step({n:2,title:'Create a new Bin',
      body:'After logging in, click <strong style="color:var(--gold);">+ CREATE BIN</strong>. Paste in this JSON as the starting content, then click Save.',
      code:'{"_v":0,"teams":[],"fixtures":[],"players":[],"squads":{},"teamchat":{},"predictions":{},"ratings":{},"comments":{},"motm":{},"knockout":{"bracket":[],"generated":false},"leagueSettings":{"name":"Ramadan YASH League","subname":"LEAGUE 2026","theme":"dark"}}',
      img:"After saving, copy the Bin ID from the URL ‚Äî looks like: 6641a2f3acd3cb34a83f1234"})}
    ${step({n:3,title:"Get your Master API Key",
      body:'In JSONBin dashboard ‚Üí click your profile ‚Üí <strong style="color:var(--gold);">API Keys</strong> ‚Üí copy the <strong>Master Key</strong>. It starts with <span style="color:var(--neon);font-family:monospace;">$2a$10$...</span>',
      img:"Keep this key private ‚Äî only paste it in your private GitHub repo"})}
    ${step({n:4,title:"Paste keys into the HTML file",
      body:'Open <strong style="color:var(--gold);">index.html</strong> and find these two lines near the top of the &lt;script&gt; section:',
      code:'const JSONBIN_BIN_ID  = "PASTE_YOUR_BIN_ID_HERE";\nconst JSONBIN_API_KEY = "PASTE_YOUR_MASTER_KEY_HERE";'})}
    ${step({n:5,title:"Push to GitHub",
      body:'Save the file, commit and push to your repo. GitHub Pages will update in ~1 minute. Done! Every device now shares the same live data.',
      img:"Every save (result, team, message) syncs to JSONBin within 1 second. All visitors refresh automatically every 15 seconds."})}
  </div>
  <div class="card" style="margin-top:16px;border-color:rgba(57,255,138,.2);">
    <div style="color:var(--neon);font-weight:700;font-size:14px;margin-bottom:10px;">üí° How It Works After Setup</div>
    <div style="display:flex;flex-direction:column;gap:8px;">
      ${["Admin enters a result ‚Üí saved to JSONBin within ~1 second",
         "Everyone's app polls JSONBin every 15 seconds for changes",
         "If data changed, their screen refreshes automatically",
         "localStorage used as instant cache ‚Äî app loads fast even offline",
         "If JSONBin is unreachable, app falls back to last cached data"].map(t=>`
        <div style="display:flex;gap:10px;align-items:center;padding:8px 12px;background:rgba(57,255,138,.04);border-radius:8px;border-left:3px solid rgba(57,255,138,.3);">
          <span style="color:var(--neon);flex-shrink:0;">‚úì</span>
          <span style="color:var(--gray2);font-size:13px;">${t}</span>
        </div>`).join("")}
    </div>
  </div>
  <div style="margin-top:16px;">
    <button class="btn btn-gold btn-sm" onclick="navigate('admin')">${icon("check",14)} Back to Admin Panel</button>
  </div>`;
}

function renderRules() {
  const sections = [
    {title:"I. Team Composition & Rosters",icon:"üë•",items:[
      "Format: Matches are played in a <strong style='color:var(--gold)'>7v7 format</strong>.",
      "Squad Size: Each team consists of 7 active players (+1), along with 3 substitutions and 2 reserves.",
      "Substitution Policy: Once a player has been substituted out of a match, they are <strong style='color:var(--red)'>not permitted to re-enter</strong> that specific game.",
      "Transfers & Loans: Teams may sign or loan a maximum of <strong style='color:var(--gold)'>5 players</strong> to ensure fair play.",
      "Transfers and loans must be finalized and reported to the league before the tournament begins.",
      "Once the tournament is underway, <strong style='color:var(--red)'>no player swaps or transfers</strong> between confirmed teams are allowed.",
    ]},
    {title:"II. Match Play & Game Rules",icon:"‚öΩ",items:[
      "Duration: Matches consist of a <strong style='color:var(--neon)'>50-minute regulation period</strong> with a 10-minute halftime interval.",
      "Extra Time: A maximum of <strong style='color:var(--gold)'>15 minutes</strong> of extra time may be added at the referee's discretion.",
      "Offside: There is <strong style='color:var(--neon)'>no offside rule</strong> in effect for this league.",
      "Penalty Kicks: Taken from the edge of the penalty box.",
      "Defensive Walls: Players are restricted from forming a wall of more than <strong style='color:var(--gold)'>3 persons</strong>.",
      "Handballs: Result in either a penalty or a free kick depending on the location of the infraction.",
    ]},
    {title:"III. Safety, Equipment & Conduct",icon:"üõ°Ô∏è",items:[
      "Mandatory Gear: <strong style='color:var(--gold)'>Shin guards are compulsory</strong> for all players. Goalkeepers must wear gloves.",
      "Footwear: Proper athletic footwear must be worn; <strong style='color:var(--red)'>metal studs or unsafe shoes are strictly prohibited.</strong>",
      "Yellow Cards: Serve as an official warning. Accumulating <strong style='color:var(--gold)'>two yellow cards</strong> in a single match results in a dismissal (sending off).",
      "Red Cards: Issued for intentional fouls, violent conduct, or reckless challenges. Results in an <strong style='color:var(--red)'>immediate match ban and a suspension for 2‚Äì3 subsequent matches.</strong>",
      "Zero tolerance for racism, fighting, or verbal abuse toward players or league staff.",
      "Referee's decisions are final. Arguing with officials will lead to disciplinary action.",
    ]},
    {title:"IV. Finance & Registration",icon:"üí∞",items:[
      "Registration Fee: The total registration fee per team is <strong style='color:var(--gold)'>10 AED</strong>.",
      "Deadline: Teams must be fully registered and fees paid <strong style='color:var(--neon)'>2 weeks prior</strong> to the league start date.",
      "Eligibility: No team or player will be permitted to participate until the registration fee is settled in full.",
    ]},
    {title:"V. Prizes & Awards",icon:"üèÜ",items:[
      "Prize Pool: Collected registration fees are converted into the league prize money.",
      "ü•á 1st Place: <strong style='color:var(--gold)'>Trophy + 60% of the prize pool.</strong>",
      "ü•à 2nd Place: <strong style='color:#c0c8d8'>Medals + 20% of the prize pool.</strong>",
      "Awards are strictly for players who participated through the duration of the match (including active substitutes).",
    ]},
  ];
  return `
  <div class="section-title">${icon("shield",20)} RYL Official Rules & Regulations</div>
  <div style="background:linear-gradient(135deg,rgba(240,192,64,.1),rgba(57,255,138,.05));border:1px solid rgba(240,192,64,.18);border-radius:20px;padding:20px 24px;margin-bottom:24px;">
    <div style="font-family:'Exo 2',sans-serif;font-weight:900;font-size:18px;color:var(--gold);">Ramadan Yash League (RYL)</div>
    <div style="color:var(--gray2);font-size:13px;margin-top:4px;">Official Rules & Regulations ‚Äî Season 2026 ¬∑ 7v7 Format</div>
  </div>
  <div style="display:flex;flex-direction:column;gap:16px;">
    ${sections.map(s=>`
    <div class="card">
      <div style="color:var(--gold);font-family:'Exo 2',sans-serif;font-weight:700;font-size:16px;margin-bottom:14px;">${s.icon} ${s.title}</div>
      <div style="display:flex;flex-direction:column;gap:8px;">
        ${s.items.map(item=>`<div style="display:flex;gap:10px;align-items:flex-start;padding:8px 12px;background:rgba(255,255,255,.03);border-radius:8px;border-left:3px solid rgba(240,192,64,.3);">
          <span style="color:var(--gold);flex-shrink:0;margin-top:1px;">${icon("check",14)}</span>
          <span style="color:var(--gray2);font-size:13.5px;line-height:1.5;">${item}</span>
        </div>`).join("")}
      </div>
    </div>`).join("")}
  </div>`;
}

// Postpone Match
function openPostponeMatch(fid) {
  const f = fixtures.find(x=>x.id===fid);
  if(!f) return;
  const h=teamById(f.home), a=teamById(f.away);
  modal(`
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
    <div style="color:var(--orange);font-family:'Exo 2',sans-serif;font-weight:800;font-size:18px;">‚è∏Ô∏è Postpone Match</div>
    <button class="btn btn-dark btn-xs" onclick="closeModalBtn()">${icon("x",16)}</button>
  </div>
  <div style="padding:12px;background:rgba(255,153,51,.08);border:1px solid rgba(255,153,51,.2);border-radius:12px;margin-bottom:18px;text-align:center;">
    <div style="color:var(--white);font-weight:700;margin-bottom:4px;">${h.name} vs ${a.name}</div>
    <div style="color:var(--gray);font-size:12px;">${f.date||"TBD"} ¬∑ ${f.time}</div>
  </div>
  <div style="margin-bottom:14px;"><label class="inp-label">New Date</label><input type="date" id="pp-date" class="inp" value="${f.date||''}"/></div>
  <div style="margin-bottom:22px;"><label class="inp-label">New Time</label><input type="time" id="pp-time" class="inp" value="${f.time||'20:00'}" style="width:auto;"/></div>
  <div style="display:flex;gap:10px;">
    <button class="btn btn-md" style="background:linear-gradient(135deg,var(--orange),#cc7700);color:#fff;" onclick="savePostpone(${fid})">${icon("calendar",16)} Confirm Postpone</button>
    <button class="btn btn-ghost btn-md" onclick="closeModalBtn()">Cancel</button>
  </div>`);
}
function savePostpone(fid){
  const newDate=document.getElementById("pp-date").value;
  const newTime=document.getElementById("pp-time").value||"20:00";
  const fi=fixtures.findIndex(f=>f.id===fid);
  if(fi<0) return;
  fixtures[fi]={...fixtures[fi],date:newDate,time:newTime,status:"postponed"};
  saveState();
  closeModalBtn();
  showToast("‚è∏Ô∏è Match postponed successfully.");
  navigate(currentPage);
}

// ================================================================
// TOAST
// ================================================================
function showToast(msg) {
  const t=document.createElement("div");
  t.textContent=msg;
  t.style.cssText="position:fixed;bottom:24px;right:24px;z-index:999;background:linear-gradient(135deg,var(--navy3),var(--navy4));border:1px solid rgba(240,192,64,.3);color:var(--white);padding:12px 20px;border-radius:12px;font-size:14px;font-weight:600;box-shadow:0 8px 32px rgba(0,0,0,.5);animation:fadeUp .3s ease;";
  document.body.appendChild(t);
  setTimeout(()=>t.remove(),3000);
}

// ================================================================
// SIDEBAR TOGGLE
// ================================================================
function toggleSidebar(){
  const sb=document.getElementById("sidebar");
  sb.classList.toggle("collapsed");
  sb.classList.toggle("mob-open");
}

// ================================================================
// AFTER RENDER HOOKS
// ================================================================
function afterRender(page){
  if(page==="fixtures"){
    const mds=[...new Set(fixtures.map(f=>f.md))].sort((a,b)=>a-b);
    if(mds.length>0) filterMD(mds[0]);
  }
  if(page==="messages"||page==="teamchat"){
    const c=document.getElementById(page==="messages"?"chat-msgs":"tc-msgs");
    if(c) setTimeout(()=>c.scrollTop=c.scrollHeight,50);
  }
}

// ================================================================
// STAR FIELD
// ================================================================
(function createStars(){
  const c=document.getElementById("stars");
  for(let i=0;i<65;i++){
    const s=document.createElement("div");
    s.className="star";
    const size=Math.random()*2+.5;
    s.style.cssText=`width:${size}px;height:${size}px;left:${Math.random()*100}%;top:${Math.random()*100}%;--d:${3+Math.random()*4}s;--delay:${Math.random()*6}s;opacity:${.1+Math.random()*.5};`;
    c.appendChild(s);
  }
})();

// Handle Enter key on login
document.addEventListener("keydown",function(e){
  if(e.key==="Escape") closeModalBtn();
});
</script>
</body>
</html>
